---
export const prerender = false;

import Page from '@/layouts/Page.astro';
import { getLangFromUrl, useTranslations } from '@/i18n/utils';
import { slugify } from '@/utils/string';
import { getEntry, render, type CollectionEntry } from 'astro:content';
import { Image } from 'astro:assets';
import Chip from '@/components/Chip.astro';
import Button from '@/components/buttons/Button.astro';
import { formatEventDate } from '@/utils/date';
import Container from '@/components/Container.astro';
import { CompanyName } from '@/config/company';
import EventMetas from '@/components/events/EventMetas.astro';
import { formatPrice } from '@/utils/format';
import RouteCard from '@/components/RouteCard.astro';
type Props = {
	event: CollectionEntry<'events'>;
};
import '@/styles/routes.css';

const { event } = Astro.props;
const slug = slugify(event.id);
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const eventDate = new Date(event.data.date);
const endDate = event.data.endDate ? new Date(event.data.endDate) : null;
const formattedDate = formatEventDate(eventDate, endDate, lang);

const eventTitle = event.data.title;

const eventDescription =
	lang === 'es' ? event.data.summaryEs : event.data.summaryEu;

const eventTypeMap: Record<string, string> = {
	mountain: t('event.type.mountain'),
	'ski-alpino': t('event.type.ski-alpino'),
	event: t('event.type.event'),
	course: t('event.type.course')
};

const eventType = eventTypeMap[event.data.type] || event.data.type;
const isFinished = new Date() > eventDate;

const descriptionEntry = await getEntry(
	'eventsMarkdown',
	event.id + '/description' + lang
);

const { Content: DescriptionContent } = descriptionEntry
	? await render(descriptionEntry)
	: { Content: null };

const extraInfoEntry = await getEntry(
	'eventsMarkdown',
	event.id + '/extrainfo' + lang
);

const { Content: ExtraInfoContent } = extraInfoEntry
	? await render(extraInfoEntry)
	: { Content: null };

const priceDescriptionEntry = await getEntry(
	'eventsMarkdown',
	event.id + '/pricedescription' + lang
);

const { Content: PriceDescriptionContent } = priceDescriptionEntry
	? await render(priceDescriptionEntry)
	: { Content: null };
---

<Page
	seo={{
		title: eventTitle + ' - ' + t('nav.agenda') + ' - ' + CompanyName,
		description: eventDescription,
		openGraphProps: {
			title: eventTitle + ' - ' + t('nav.agenda') + ' - ' + CompanyName,
			description: eventDescription,
			image: event.data.image.src
		}
	}}
	Tag="article"
>
	<header class="event-hero">
		<Image
			src={event.data.image}
			style={`view-transition-name: image-${slug}`}
			alt={event.data.title}
			class="hero-image"
			layout="full-width"
		/>
	</header>

	<Container class="event-container">
		<div class="chip-row">
			<Chip variant="primary" style={`view-transition-name: date-chip-${slug}`}>
				{formattedDate}
			</Chip>
			<Chip variant="success">
				{eventType}
			</Chip>
			{
				isFinished && (
					<Chip
						variant="error"
						style={`view-transition-name: past-event-chip-${slug}`}
					>
						{t('event.finished')}
					</Chip>
				)
			}
		</div>

		<h1 class="title h3" style={`view-transition-name: title-${slug}`}>
			{event.data.title}
		</h1>

		{
			descriptionEntry?.body && (
				<section aria-labelledby="description">
					<h2 id="description" class="subtitle">
						{t('Deskribapena')}
					</h2>
					{DescriptionContent && <DescriptionContent />}
				</section>
			)
		}
		<section class="" aria-labelledby="features">
			<h2 id="features" class="subtitle">{t('Ezaugarriak')}</h2>
			<div class="event-meta-container"><EventMetas item={event} /></div>
		</section>
		{
			extraInfoEntry?.body && (
				<section aria-labelledby="additional-info">
					<h2 id="additional-info" class="subtitle">
						{t('Informazio gehigarria')}
					</h2>
					{ExtraInfoContent && <ExtraInfoContent />}
				</section>
			)
		}
		{
			event.data.routes && event.data.routes.length > 0 && (
				<section aria-labelledby="routes">
					<h2 id="routes" class="subtitle">
						{t('Ibilbideak')}
					</h2>
					<ul class="route-list">
						{event.data.routes.map(route => (
							<li class="route-list__item">
								<RouteCard
									route={{
										wikilocUrl: route.url,
										titleEu: route.labelEu,
										titleEs: route.labelEs,
										image: route.image
									}}
								/>
							</li>
						))}
					</ul>
				</section>
			)
		}
		{
			(priceDescriptionEntry?.body ||
				(event.data.prices && event.data.prices.length > 0)) && (
				<section aria-labelledby="price-description">
					<h2 id="price-description" class="subtitle">
						{t('Prezioa')}
					</h2>
					{PriceDescriptionContent && <PriceDescriptionContent />}
					{event.data.prices && event.data.prices.length > 0 && (
						<dl class="prices-list">
							{event.data.prices.map(price => (
								<>
									<dt class="price-item subtitle">
										{lang === 'es' ? price.labelEs : price.labelEu}
									</dt>
									<dd class="price-item item__price subtitle">
										{formatPrice(price.price)}
										<meta itemprop="priceCurrency" content="EUR" />
									</dd>
								</>
							))}
						</dl>
					)}
				</section>
			)
		}
	</Container>
	<section class="inscription-container">
		<Container>
			<h2 class="registration-title subtitle">
				{t('Izen ematea')}
			</h2>
			<p class="registration-info">
				{t('event.registrationInfo')}
			</p>
			<Button
				href="mailto:besaide@besaide.eus"
				target="_blank"
				rel="noopener noreferrer"
				variant="primary"
			>
				{t('event.register')}
			</Button>
		</Container>
	</section>
</Page>

<style>
	.event-hero {
		position: relative;
		width: 100%;
		height: 60vh;
		min-height: 400px;
		max-height: 800px;
		overflow: hidden;
		margin-bottom: var(--s8);
	}

	.event-container {
		display: flex;
		flex-direction: column;
		gap: var(--s4);
		margin-bottom: var(--s6);
	}

	.hero-image {
		width: 100%;
		height: 100%;
		object-fit: cover;
		display: block;
	}

	.chip-row {
		display: flex;
		gap: var(--s3);
		flex-wrap: wrap;
		margin-bottom: var(--s4);
	}

	.event-meta-container {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
		gap: var(--s5);
	}

	.summary {
		font-weight: var(--font-weight-normal);
		margin-bottom: var(--s6);
		padding: var(--s5);
		background: var(--theme-primary-container);
		border-radius: var(--theme-shape-radius);
		color: var(--theme-on-bg);
		line-height: 1.5;
	}

	.content :global(h2) {
		font-size: var(--font-size-h2);
		font-weight: var(--font-weight-medium);
		margin: var(--s8) 0 var(--s4);
		color: var(--theme-on-bg);
	}

	.content :global(h3) {
		font-size: var(--font-size-h3);
		font-weight: var(--font-weight-medium);
		margin: var(--s6) 0 var(--s3);
		color: var(--theme-on-bg);
	}

	.content :global(p) {
		line-height: 1.5;
		margin-bottom: var(--s5);
		color: var(--theme-on-bg);
	}

	.content :global(ul),
	.content :global(ol) {
		margin-bottom: var(--s5);
		padding-left: var(--s6);
	}

	.content :global(li) {
		line-height: 1.5;
		margin-bottom: var(--s2);
		color: var(--theme-on-bg);
	}

	.content :global(a) {
		color: var(--theme-primary);
		font-weight: var(--font-weight-medium);
		text-decoration: underline;
	}

	.cta-section {
		display: flex;
		justify-content: center;
		margin-top: var(--s8);
		padding: var(--s8) 0;
		border-top: 1px solid var(--theme-outline);
	}
	.prices-list {
		display: grid;
		grid-template-columns: 1fr auto;
	}

	.price-item {
		display: flex;
		align-items: center;
		gap: var(--s2);
		padding: var(--s4) 0;
		border-bottom: 1px solid var(--theme-separator);
		transition: background-color 0.2s ease;
		width: 100%;
	}

	.item__price {
		font-weight: 600;
		color: var(--theme-primary-900);
		margin: 0 0 0 auto;
	}
	.inscription-container {
		padding: var(--s6);
		margin-top: var(--s6);
		background-color: var(--theme-primary-container-alt);
	}

	:global([data-theme='dark']) .item__price {
		color: var(--theme-on-primary);
	}

	@media (max-width: 768px) {
		.event-hero {
			height: 50vh;
			min-height: 300px;
		}
		.event-meta-container {
			grid-template-columns: 1fr;
			gap: var(--s4);
			padding: var(--s6);
		}

		.chip-row {
			gap: var(--s2);
		}
	}
</style>
