---
import Page from '@/layouts/Page.astro';
import { getLangFromUrl, useTranslations } from '@/i18n/utils';
import { slugify } from '@/utils/string';
import { render, type CollectionEntry } from 'astro:content';
import { Image } from 'astro:assets';
import { processEventImage } from '@/utils/images';
import Chip from '@/components/Chip.astro';
import Button from '@/components/buttons/Button.astro';
import CardMeta from '@/components/events/CardMeta.astro';
import { Map, Clock3 } from '@lucide/astro';
import DistanceIcon from '@/assets/icons/distance.svg';
import ElevationIcon from '@/assets/icons/elevation.svg';
import LevelIcon from '@/assets/icons/level.svg';
import { formatEventDate } from '@/utils/date';
import Container from '@/components/Container.astro';

type Props = {
	event: CollectionEntry<'events'>;
};
const { event }: Props = Astro.props;
const { Content } = await render(event);
const slug = slugify(event.id);
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const processedImage = await processEventImage(event.id, event.data.image);

type Difficulty = 'erraza' | 'ertaina' | 'zaila';

const difficultyLabels: Record<'eu' | 'es', Record<Difficulty, string>> = {
	eu: {
		erraza: 'Erraza',
		ertaina: 'Ertaina',
		zaila: 'Zaila'
	},
	es: {
		erraza: 'Fácil',
		ertaina: 'Media',
		zaila: 'Difícil'
	}
};

const eventDate = new Date(event.data.date);
const endDate = event.data.endDate ? new Date(event.data.endDate) : null;
const formattedDate = formatEventDate(eventDate, endDate, lang);
const discriminant = event.data.typeSpecificFields.discriminant;

const { mountain, elevation, difficulty } =
	discriminant === 'mountain' ? event.data.typeSpecificFields.value : {};

const { location } =
	discriminant === 'ski-alpino' ? event.data.typeSpecificFields.value : {};

const eventTypeMap = {
	mountain: t('event.type.mountain'),
	'ski-alpino': t('event.type.ski-alpino'),
	'ski-fondo': t('event.type.ski-fondo'),
	trekking: t('event.type.trekking')
};

const eventType = eventTypeMap[discriminant];
const isFinished = new Date() > eventDate;
---

<Page seo={{ title: 'Besaide - Agenda ' + ' - ' + event.data.title }}>
	<article>
		<header class="event-hero">
			<Image
				src={processedImage}
				style={`view-transition-name: image-${slug}`}
				alt={event.data.title}
				class="hero-image"
			/>
		</header>

		<Container class="event-container">
			<div class="chip-row">
				<Chip variant="primary">
					{formattedDate}
				</Chip>
				<Chip variant="success">
					{eventType}
				</Chip>
				{isFinished && <Chip variant="error">{t('event.finished')}</Chip>}
			</div>

			<h1 class="title h3" style={`view-transition-name: title-${slug}`}>
				{event.data.title}
			</h1>
			<Content />

			<div class="event-meta-container">
				{
					discriminant === 'mountain' ? (
						<CardMeta
							title={lang === 'eu' ? 'MENDIA' : 'MONTAÑA'}
							desc={mountain || ''}
						>
							<Map slot="icon" />
						</CardMeta>
					) : discriminant === 'ski-alpino' ? (
						<CardMeta title={t('KOKALEKUA')} desc={location || ''}>
							<Map slot="icon" />
						</CardMeta>
					) : (
						<CardMeta title={t('MENDIA')} desc={mountain || location || ''}>
							<Map slot="icon" />
						</CardMeta>
					)
				}
				{
					event.data.meetingPoint && (
						<CardMeta
							title={t('TOPAGUNEA')}
							desc={`${event.data.meetingPoint}${event.data.time ? ' - ' + event.data.time : ''}`}
						>
							<DistanceIcon
								slot="icon"
								color="currentColor"
								fill="currentColor"
							/>
						</CardMeta>
					)
				}
				{
					event.data.duration && (
						<CardMeta title={t('IRAUPENA')} desc={event.data.duration}>
							<Clock3 slot="icon" />
						</CardMeta>
					)
				}
				{
					elevation && (
						<CardMeta
							title={lang === 'eu' ? 'DESNIBELA' : 'DESNIVEL'}
							desc={elevation}
						>
							<ElevationIcon slot="icon" />
						</CardMeta>
					)
				}
				{
					difficulty && (
						<CardMeta
							title={t('MAILA')}
							desc={difficultyLabels[lang][difficulty]}
						>
							<LevelIcon slot="icon" fill="currentColor" />
						</CardMeta>
					)
				}
			</div>

			<h2 class="registration-title subtitle">{t('Izen ematea')}</h2>
			<p class="registration-info">
				{t('event.registrationInfo')}
			</p>
			<Button href="mailto:besaide@besaide.eus" variant="primary">
				{t('event.register')}
			</Button>
		</Container>
	</article>
</Page>

<style>
	.event-hero {
		position: relative;
		width: 100%;
		height: 60vh;
		min-height: 400px;
		max-height: 800px;
		overflow: hidden;
		margin-bottom: var(--s8);
	}

	.event-container {
		display: flex;
		flex-direction: column;
		gap: var(--s4);
		margin-bottom: var(--s6);
	}

	.registration-title,
	.registration-info {
		margin-bottom: 0;
	}

	.hero-image {
		width: 100%;
		height: 100%;
		object-fit: cover;
		display: block;
	}

	.chip-row {
		display: flex;
		gap: var(--s3);
		flex-wrap: wrap;
		margin-bottom: var(--s4);
	}

	.title {
		margin-bottom: 0;
	}

	.event-meta-container {
		background-color: var(--theme-primary-container);
		color: var(--theme-on-bg);
		padding: var(--s8);
		border-radius: var(--theme-shape-radius);
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
		gap: var(--s6);
		margin-bottom: var(--s4);
	}

	.summary {
		font-weight: var(--font-weight-normal);
		margin-bottom: var(--s6);
		padding: var(--s5);
		background: var(--theme-primary-container);
		border-radius: var(--theme-shape-radius);
		color: var(--theme-on-bg);
		line-height: 1.5;
	}

	.content :global(h2) {
		font-size: var(--font-size-h2);
		font-weight: var(--font-weight-medium);
		margin: var(--s8) 0 var(--s4);
		color: var(--theme-on-bg);
	}

	.content :global(h3) {
		font-size: var(--font-size-h3);
		font-weight: var(--font-weight-medium);
		margin: var(--s6) 0 var(--s3);
		color: var(--theme-on-bg);
	}

	.content :global(p) {
		line-height: 1.5;
		margin-bottom: var(--s5);
		color: var(--theme-on-bg);
	}

	.content :global(ul),
	.content :global(ol) {
		margin-bottom: var(--s5);
		padding-left: var(--s6);
	}

	.content :global(li) {
		line-height: 1.5;
		margin-bottom: var(--s2);
		color: var(--theme-on-bg);
	}

	.content :global(a) {
		color: var(--theme-primary);
		font-weight: var(--font-weight-medium);
		text-decoration: underline;
	}

	.cta-section {
		display: flex;
		justify-content: center;
		margin-top: var(--s8);
		padding: var(--s8) 0;
		border-top: 1px solid var(--theme-outline);
	}

	@media (max-width: 768px) {
		.event-hero {
			height: 50vh;
			min-height: 300px;
		}
		.event-meta-container {
			grid-template-columns: 1fr;
			gap: var(--s4);
			padding: var(--s6);
		}

		.chip-row {
			gap: var(--s2);
		}
	}
</style>
