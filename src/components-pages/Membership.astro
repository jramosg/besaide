---
import Container from '@/components/Container.astro';
import PageHeader from '@/components/PageHeader.astro';
import ExtrasTable from '@/components/ExtrasTable.astro';
import MembershipForm from '@/components/MembershipForm.astro';
import { getLangFromUrl, getUrlFromID, useTranslations } from '@/i18n/utils';
import Page from '@/layouts/Page.astro';
import { getEntry, render } from 'astro:content';
import InfoIcon from '@lucide/astro/icons/info';
import EuskalMendiFederazioaLogo from '@/assets/emf.webp';
import { Image } from 'astro:assets';
import { formatPrice } from '@/utils/format';
import FormSection from '@/components/FormSection.astro';
import { randomUUID } from 'crypto';
import Button from '@/components/buttons/Button.astro';
import type { Errors, FormData } from '@/types/Form';

const url = Astro.url;

const lang = getLangFromUrl(url);
const t = useTranslations(lang);

let errors: Errors = {
	dni: '',
	name: '',
	surnames: '',
	birthdate: '',
	address: '',
	town: '',
	postalCode: '',
	province: '',
	phone1: '',
	phone2: '',
	email: '',
	acceptTerms: ''
};

let formData: FormData = {};

let isSuccessPage = false;

if (Astro.request.method === 'POST') {
	try {
		const data = await Astro.request.formData();

		// Extract all form data
		const dni = data.get('dni');
		const name = data.get('name');
		const surnames = data.get('surnames');
		const birthdate = data.get('birthdate');
		const address = data.get('address');
		const town = data.get('town');
		const postalCode = data.get('postal-code');
		const province = data.get('province');
		const phone1 = data.get('phone1');
		const phone2 = data.get('phone2');
		const email = data.get('email');
		const infoSpanish = data.get('info-spanish') === 'on';
		const membership = data.get('membership') === 'on';
		const federation = data.get('federation') === 'on';
		const acceptTerms = data.get('accept-terms') === 'on';

		// Store form data for repopulation on error
		formData = {
			dni,
			name,
			surnames,
			birthdate,
			address,
			town,
			postalCode,
			province,
			phone1,
			phone2,
			email,
			infoSpanish,
			membership,
			federation,
			acceptTerms
		};

		// Validation
		if (typeof dni !== 'string' || dni.length < 1) {
			errors.dni = t('form.error.required');
		}
		if (typeof name !== 'string' || name.length < 1) {
			errors.name = t('form.error.required');
		}
		if (typeof surnames !== 'string' || surnames.length < 1) {
			errors.surnames = t('form.error.required');
		}
		if (typeof birthdate !== 'string' || birthdate.length < 1) {
			errors.birthdate = t('form.error.required');
		}
		if (typeof address !== 'string' || address.length < 1) {
			errors.address = t('form.error.required');
		}
		if (typeof town !== 'string' || town.length < 1) {
			errors.town = t('form.error.required');
		}
		if (typeof postalCode !== 'string' || postalCode.length < 1) {
			errors.postalCode = t('form.error.required');
		} else if (!/^\d{5}$/.test(postalCode)) {
			errors.postalCode = t('form.error.postal-code');
		}
		if (typeof province !== 'string' || province.length < 1) {
			errors.province = t('form.error.required');
		}
		if (typeof phone1 !== 'string' || phone1.length < 1) {
			errors.phone1 = t('form.error.required');
		} else if (!/^\+?[\d\s-()]+$/.test(phone1)) {
			errors.phone1 = t('form.error.phone');
		}
		if (phone2 && typeof phone2 === 'string' && phone2.length > 0) {
			if (!/^\+?[\d\s-()]+$/.test(phone2)) {
				errors.phone2 = t('form.error.phone');
			}
		}
		if (typeof email !== 'string' || email.length < 1) {
			errors.email = t('form.error.required');
		} else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
			errors.email = t('form.error.email');
		}
		if (!acceptTerms) {
			errors.acceptTerms = t('form.error.accept-terms');
		}

		const hasErrors = Object.values(errors).some(msg => msg);

		if (!hasErrors) {
			// TODO: Send email
			// For now, log the data
			console.log('Form submitted successfully:', formData);
			isSuccessPage = true;
		}
	} catch (error) {
		if (error instanceof Error) {
			console.error('error', error.message);
		}
	}
}

console.log('isSuccessPage', isSuccessPage);

const membership = await getEntry('membership', 'membership');

if (!membership) {
	throw new Error('Membership content not found');
}

const federation = await getEntry('federation', 'federation');

if (!federation) {
	throw new Error('Federation content not found');
}

const federationContentEntry = await getEntry(
	'federationContent',
	'content' + lang
);

if (!federationContentEntry) {
	throw new Error('Federation content not found in lang ' + lang);
}

const { Content: FederationContent } = await render(federationContentEntry);

// Helper function to split label and make first word bold
function formatPriceLabel(label: string, price: number) {
	const parts = label.split(' ');
	const firstWord = parts[0];
	const rest = parts.slice(1).join(' ');
	return { firstWord, rest, price };
}

// Age category headers
const ageCategories = [
	{ eu: 'Haurrak (0-13 urte)', es: 'Niños (0-13 años)	', key: 'priceChildren' },
	{ eu: 'Gazteak (14-17 urte)', es: 'Jóvenes (14-17 años)', key: 'priceYouth' },
	{
		eu: 'Nagusiak (18-64 urte)',
		es: 'Adultos (18-64 años)',
		key: 'priceAdults'
	},
	{ eu: 'Nagusiak >65 urte', es: 'Adultos >65 años', key: 'priceSeniors' }
] as const;

const pricingTable = federation.data.pricingTable;
const pricingNumberOfRows = pricingTable ? pricingTable.length : 0;
---

<Page
	seo={{
		title: t('membership.seo.title'),
		description: t('membership.seo.description'),
		openGraphProps: {
			title: t('membership.seo.title'),
			description: t('membership.seo.description')
		}
	}}
>
	<Container
		class="container__membership"
		tag="section"
		aria-labelledby="membership-title"
	>
		<PageHeader
			title={t('Bazkidetza')}
			subtitle={t(
				'2025eko Besaide Mendizale Elkarteko bazkide kuotak honako hauek dira'
			) + ':'}
			id="bazkidetza"
		/>

		<ul class="prices-list">
			{
				membership.data.prices.map(item => {
					const label = lang === 'eu' ? item.labelEu : item.labelEs;
					const formatted = formatPriceLabel(label, item.price);

					return (
						<li class="price-item">
							<h2 class="price-category">
								<strong>{formatted.firstWord}</strong> {formatted.rest}
							</h2>
							<p class="price-amount">
								<span class="price-value">{formatPrice(formatted.price)}</span>
								<meta itemprop="priceCurrency" content="EUR" />
							</p>
						</li>
					);
				})
			}
		</ul>

		<aside class="card__membership--benefits" aria-labelledby="benefits-title">
			<h2 id="benefits-title" class="benefits-title h4">
				{t('Bazkide izatearen abantailak')}
			</h2>
			<p class="benefits-description">
				{
					lang === 'eu'
						? membership.data.benefitsEu
						: membership.data.benefitsEs
				}
			</p>
		</aside>
	</Container>

	{
		pricingTable && (
			<section
				class="section__federation content__container"
				aria-labelledby="federatzea"
			>
				<h1 id="federatzea" class="h2">
					{t('Federatzea')}
				</h1>
				<div class="federation-info-grid">
					<FederationContent />
					<div class="federation-info-card">
						<div class="info-icon-container">
							<InfoIcon size={24} aria-hidden="true" />
						</div>
						{lang === 'eu'
							? federation.data.infoCardEu
							: federation.data.infoCardEs}
					</div>
					<Image
						class="euskal-mendi-federazioa-logo"
						src={EuskalMendiFederazioaLogo}
						alt="Euskal Mendi Federazioa Logo"
						width={172}
						height={98}
					/>
				</div>
				{/* Desktop Table View */}
				<div class="table-wrapper" role="region" tabindex={0}>
					<table
						class="federation-table"
						itemscope
						itemtype="https://schema.org/Table"
					>
						<thead>
							<tr>
								<th scope="col">{lang === 'eu' ? 'Eskualdea' : 'Región'}</th>
								{ageCategories.map(cat => (
									<th scope="col">{lang === 'eu' ? cat.eu : cat.es}</th>
								))}
							</tr>
						</thead>
						<tbody>
							{pricingTable.map((row, index) => (
								<tr itemscope itemtype="https://schema.org/Offer">
									<th scope="row" itemprop="category">
										{lang === 'eu' ? row.regionEu : row.regionEs}
									</th>
									{ageCategories.map(cat => (
										<td
											class={
												index === pricingNumberOfRows - 1 ? 'price-latest' : ''
											}
										>
											<span itemprop="price">{formatPrice(row[cat.key])}</span>{' '}
											<meta itemprop="priceCurrency" content="EUR" />
										</td>
									))}
								</tr>
							))}
						</tbody>
					</table>
				</div>

				{/* Mobile Card View */}
				<div class="federation-cards">
					{pricingTable.map(row => (
						<article
							class="federation-card"
							itemscope
							itemtype="https://schema.org/Offer"
						>
							<h2 class="card-region" itemprop="category">
								{lang === 'eu' ? row.regionEu : row.regionEs}
							</h2>
							<dl class="card-prices">
								{ageCategories.map(cat => (
									<div class="price-row">
										<dt class="price-label">
											{lang === 'eu' ? cat.eu : cat.es}
										</dt>
										<dd class="price-value">
											<span itemprop="price">{formatPrice(row[cat.key])}</span>{' '}
											€
											<meta itemprop="priceCurrency" content="EUR" />
										</dd>
									</div>
								))}
							</dl>
						</article>
					))}
				</div>
			</section>
		)
	}

	{
		federation.data.extras && federation.data.extras.length > 0 && (
			<section
				class="section__extras content__container"
				aria-labelledby="extras-title"
			>
				<h2 id="extras-title" class="h3">
					{t('Gehigarriak')}
				</h2>
				<ExtrasTable extras={federation.data.extras} lang={lang} />
			</section>
		)
	}
	{
		isSuccessPage ? (
			<FormSection aria-labelledby="federation-received">
				<Container narrow class="federation-success-message">
					<h2 class="sr-only federation-received">
						{t('Federazio eskaera jaso da')}
					</h2>
					<p class="subtitle">
						{t(
							'Zure datuak bidali dira. Eskaera tramitatu bezain laister, zurekin kontaktuak jarriko gara.\nEskerrik asko!'
						)}
					</p>
					<Button
						href={
							getUrlFromID('membership-federation', lang) +
							'?refill=' +
							randomUUID()
						}
					>
						{t('Beste galdetegi bat bete')}
					</Button>
				</Container>
			</FormSection>
		) : (
			<MembershipForm errors={errors} formData={formData} />
		)
	}
</Page>

<style>
	.container__membership {
		padding-bottom: var(--s6);
		display: grid;
		grid-template-columns: 1fr;
		gap: var(--s4);

		.page-title {
			grid-column: 1 / -1;
			grid-row: 1;
		}

		.page-subtitle {
			grid-column: 1;
			grid-row: 2;
		}

		@media (min-width: 768px) {
			grid-template-columns: 1fr 1fr;
		}
	}

	.prices-list {
		display: flex;
		flex-direction: column;
		gap: var(--s3);
		list-style: none;
		margin: 0;
		padding: 0;
	}

	:global([data-theme='dark']) {
		div {
			.price-value,
			.price-currency {
				color: var(--theme-on-primary);
			}
		}
	}

	.price-item {
		display: flex;
		justify-content: space-between;
		align-items: center;
		padding-bottom: var(--s3);
		border-bottom: 1px solid #92949c;
		gap: var(--s4);
	}

	.price-category {
		font-size: var(--font-size-base);
		font-weight: 400;
		margin: 0;

		strong {
			font-weight: 700;
			font-size: 1.125rem;
		}
	}

	.price-amount {
		display: flex;
		align-items: baseline;
		gap: 0.25rem;
		margin: 0;
		white-space: nowrap;
		color: var(--theme-primary-900);
	}

	.price-value {
		font-weight: 700;
		color: var(--theme-primary-900);
	}

	.price-currency {
		font-size: var(--font-size-sm);
		font-weight: var(--font-weight-semibold);
	}

	.card__membership--benefits {
		background-color: var(--theme-primary-container);
		color: var(--theme-on-bg);
		padding: var(--s7) var(--s6);
		border-radius: var(--theme-shape-radius);
		max-width: 100%;
		width: 100%;
		position: relative;
		height: fit-content;

		@media (min-width: 768px) {
			grid-column: 2;
			grid-row: 2 / span 5;
			margin-left: var(--s6);
			max-width: 560px;
		}
	}

	.benefits-description {
		margin: 0;
		line-height: 1.6;
		font-size: 1rem;
	}

	/* Federation Section */
	.section__federation,
	.section__extras {
		margin-top: var(--s6);
	}

	.federation-info-grid {
		display: grid;
		grid-template-columns: 1fr;
		gap: var(--s4);
		margin-bottom: var(--s6);
	}

	.federation-info-card {
		border-radius: var(--theme-shape-radius);
		background-color: var(--theme-primary-container);
		padding: var(--s4);
		display: flex;
		gap: var(--s4);
		font-weight: var(--font-weight-medium);
		white-space: pre-line;
	}
	.info-icon-container {
		flex-shrink: 0;
		svg {
			fill: var(--theme-primary-900);
			stroke: var(--theme-on-primary);
			circle {
				stroke: var(--theme-primary-900);
			}
		}
	}
	.euskal-mendi-federazioa-logo {
		height: auto;
		width: 172px;
		max-width: 172px;
		aspect-ratio: 172 / 98;
		align-self: center;
		justify-self: center;
		grid-column: 1;
		grid-row: 1;
	}

	.federation-success-message {
		display: flex;
		flex-direction: column;
		align-items: center;
		p {
			white-space: pre-line;
			margin-bottom: var(--s8);
			text-align: center;
			color: var(--theme-on-primary-container-colorful);
		}
	}
	@media (min-width: 768px) {
		.federation-info-grid {
			grid-template-columns: 1fr 1fr;
			row-gap: var(--s4);
		}

		.euskal-mendi-federazioa-logo {
			grid-column: 2;
			grid-row: 1 / span 2;
		}
	}

	/* Desktop Table */
	.table-wrapper {
		overflow-x: auto;
		border-radius: var(--theme-shape-radius);
		box-shadow: var(--shadow-card);
		margin-bottom: var(--s4);
	}

	.federation-table {
		width: 100%;
		border-collapse: collapse;
		background: var(--theme-card);
		font-size: 1rem;

		thead {
			background: var(--theme-primary-900);
			color: var(--theme-on-primary);
		}

		th {
			padding: var(--s4);
			text-align: left;
			font-weight: var(--font-weight-semibold);
			white-space: nowrap;
		}

		th[scope='col'] {
			text-align: center;
		}

		th[scope='row'] {
			font-weight: var(--font-weight-semibold);
			background: var(--theme-primary-container);
		}

		td {
			padding: var(--s4);
			text-align: center;
			border-bottom: 1px solid var(--theme-separator);
			font-weight: var(--font-weight-medium);
			&.price-latest {
				border-bottom: none;
			}
		}

		tbody tr:hover {
			background: var(--theme-primary-container-alt);
		}

		.currency {
			font-size: 0.875em;
			opacity: 0.8;
		}
	}

	.federation-cards {
		display: none;
	}

	@media (max-width: 1024px) {
		.table-wrapper {
			display: none;
		}

		.federation-cards {
			display: grid;
			gap: var(--s4);
		}

		.federation-card {
			background: var(--theme-card);
			border-radius: var(--theme-shape-radius);
			padding: var(--s4);
			box-shadow: var(--shadow-card);
		}

		.card-region {
			margin: 0 0 var(--s3) 0;
			padding-bottom: var(--s2);
			border-bottom: 2px solid var(--theme-primary-900);
			font-size: 1.25rem;
			font-weight: var(--font-weight-semibold);
			color: var(--theme-primary-900);
		}

		.card-prices {
			display: grid;
			gap: var(--s2);
			margin: 0;
		}

		.price-row {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: var(--s2) 0;
			border-bottom: 1px solid var(--theme-separator);
		}

		.price-row:last-child {
			border-bottom: none;
		}

		.price-label {
			font-weight: var(--font-weight-medium);
			margin: 0;
		}

		.price-value {
			font-weight: var(--font-weight-semibold);
			margin: 0;
		}
	}
</style>
