---
import Page from '@/layouts/Page.astro';
import { getLangFromUrl, getUrlFromID, useTranslations } from '@/i18n/utils';
import { sortedAndFilteredEvents } from '@/utils/events';
import EventListCard from '@/components/events/EventListCard.astro';
import PageHeader from '@/components/PageHeader.astro';
import type { ProcessedEvent } from '@/types/Events';
import { CompanyName } from '@/config/company';

const url = Astro.url;
const lang = getLangFromUrl(url);
const t = useTranslations(lang);

const today = new Date();
const agendaSection = getUrlFromID('agenda', lang);

const events = await sortedAndFilteredEvents( agendaSection, today);

// Group events by month and separate into future/past
const { futureEventsByMonth, pastEventsByMonth, futureCount } = events.reduce(
	(acc, item) => {
		const date = new Date(item.data.date);
		const year = date.getFullYear();
		const month = date.getMonth();
		const key = `${year}-${month}`;

		let title: string;
		if (lang === 'eu') {
			const monthName = new Intl.DateTimeFormat('eu', { month: 'long' }).format(
				date
			);
			const lastDigit = year % 10;
			const vowels = [0, 2, 3, 6, 8];
			const suffix = vowels.includes(lastDigit) ? 'ko' : 'eko';
			title = `${year}${suffix} ${monthName}`;
		} else {
			const monthName = new Intl.DateTimeFormat('es', { month: 'long' }).format(
				date
			);
			title = `${monthName} ${year}`;
		}

		if (item.isPast) {
			if (!acc.pastEventsByMonth.has(key)) {
				acc.pastEventsByMonth.set(key, { title, events: [], year, month });
			}
			acc.pastEventsByMonth.get(key)!.events.push(item);
		} else {
			if (!acc.futureEventsByMonth.has(key)) {
				acc.futureEventsByMonth.set(key, { title, events: [], year, month });
			}
			acc.futureEventsByMonth.get(key)!.events.push(item);
			acc.futureCount++;
		}

		return acc;
	},
	{
		futureEventsByMonth: new Map<
			string,
			{ title: string; events: ProcessedEvent[]; year: number; month: number }
		>(),
		pastEventsByMonth: new Map<
			string,
			{ title: string; events: ProcessedEvent[]; year: number; month: number }
		>(),
		futureCount: 0
	}
);

const futureMonths = Array.from(futureEventsByMonth.values());
const pastMonths = Array.from(pastEventsByMonth.values());

const pastTitle = lang === 'eu' ? 'Iraganeko irteerak' : 'Salidas pasadas';
const emptyMessage =
	lang === 'eu'
		? 'Ez dago irteerarik programatuta oraingoz.'
		: 'No hay salidas futuras programadas por el momento.';
---

<Page
	seo={{
		title: t('nav.agenda') + ' - ' + CompanyName,
		description: t('agenda.seo.description')
	}}
	pageClass="content__container"
>
	<PageHeader
		title="Agenda"
		subtitle={t('Kontsulta itzazu Besaideren irteera guztiak.')}
	/>
	{
		futureCount > 0 && (
			<p class="future-count">
				{futureCount === 1
					? t('Irteera bakarra dago planifikatuta.')
					: `${futureCount} ${t('irteera daude planifikatuta.')}`}
			</p>
		)
	}
	{
		futureMonths.length > 0 ? (
			<section class="events-list">
				{futureMonths.map(({ title, events }) => (
					<div class="month-group">
						<h2 class="month-title subtitle">{title}</h2>
						<p class="month-count">
							{events.length === 1
								? t('Irteera bakarra dago planifikatuta.')
								: `${events.length} ${t('irteera daude planifikatuta.')}`}
						</p>
						<div class="month-events">
							{events.map(item => (
								<EventListCard item={item} />
							))}
						</div>
					</div>
				))}
			</section>
		) : (
			<div class="empty-state">
				<p>{emptyMessage}</p>
			</div>
		)
	}

	{
		pastMonths.length > 0 && (
			<section class="events-section past-events">
				<h2 class="section-title">{pastTitle}</h2>
				<div class="events-list">
					{pastMonths.map(({ title, events }) => (
						<div class="month-group">
							<h3 class="month-title past subtitle">{title}</h3>
							<div class="month-events">
								{events.slice(0, 6).map(item => (
									<EventListCard item={item} />
								))}
							</div>
						</div>
					))}
				</div>
			</section>
		)
	}
</Page>

<style>
	.future-count {
		color: var(--theme-primary-900);
	}

	.month-count {
		color: var(--theme-primary-900);
		margin: -1rem 0 0.5rem 0;
	}

	.events-section {
		margin-bottom: 4rem;
	}

	.section-title {
		margin-bottom: 2rem;
		padding-bottom: 0.75rem;
		border-bottom: 3px solid var(--theme-primary);
	}

	.events-list {
		display: flex;
		flex-direction: column;
		gap: 3rem;
		margin: var(--s6) 0;
	}

	.month-group {
		display: flex;
		flex-direction: column;
		gap: 1rem;
	}

	.month-title {
		margin-bottom: 0;
	}

	.month-title.past {
		color: var(--theme-text-secondary);
	}

	.month-events {
		display: flex;
		flex-direction: column;
		gap: 1.5rem;
	}

	.past-events {
		margin-top: 3rem;
		padding-top: 3rem;
		border-top: 2px dashed #e5e7eb;
	}

	.past-events .section-title {
		border-bottom-color: #9ca3af;
		color: var(--theme-text-secondary);
	}

	.empty-state {
		text-align: center;
		padding: 4rem 2rem;
		background: #f9fafb;
		border-radius: 16px;
		margin: 2rem 0;
	}

	.empty-state p {
		color: var(--theme-text-secondary);
	}
</style>
