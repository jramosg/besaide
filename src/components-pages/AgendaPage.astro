---
import Page from '@/layouts/Page.astro';
import { getLangFromUrl, getUrlFromID, useTranslations } from '@/i18n/utils';
import { sortedAndFilteredEvents } from '@/staticPathsHelper';
import { slugify } from '@/utils/string';
import { processEventImage } from '@/utils/images';
import EventListCard from '@/components/events/EventListCard.astro';

const url = Astro.url;
const lang = getLangFromUrl(url);
const t = useTranslations(lang);

const events = await sortedAndFilteredEvents(lang);

// Separate future and past events
const today = new Date();
const futureEvents = events.filter(event => new Date(event.data.date) >= today);
const pastEvents = events.filter(event => new Date(event.data.date) < today);

const agendaSection = getUrlFromID('agenda', lang);

const processEvents = async (eventsList: typeof events) => {
	return await Promise.all(
		eventsList.map(async item => {
			const processedImage = await processEventImage(item.id, item.data.image);

			return {
				...item,
				processedImage,
				slug: `${agendaSection}/${slugify(item.id)}`
			};
		})
	);
};

const processedFutureEvents = await processEvents(futureEvents);
const processedPastEvents = await processEvents(pastEvents);

const pastTitle = lang === 'eu' ? 'Iraganeko irteerak' : 'Salidas pasadas';
const emptyMessage =
	lang === 'eu'
		? 'Ez dago etorkizuneko irteerarik programatuta oraingoz.'
		: 'No hay salidas futuras programadas por el momento.';
---

<Page
	seo={{ title: 'Besaide Mendizale Elkartea - Agenda' }}
	pageClass="content__container"
>
	<h1>Agenda</h1>
	<h2 class="body-text">
		{t('Kontsulta itzazu Besaideren irteera guztiak.')}
	</h2>
	{
		processedFutureEvents.length > 0 ? (
			<section class="events-list">
				{processedFutureEvents.map(item => <EventListCard item={item} />)}
			</section>
		) : (
			<div class="empty-state">
				<p>{emptyMessage}</p>
			</div>
		)
	}

	{
		processedPastEvents.length > 0 && (
			<section class="events-section past-events">
				<h2 class="section-title">{pastTitle}</h2>
				<div class="events-list">
					{processedPastEvents.slice(0, 6).map(item => <EventListCard item={item} />)}
				</div>
			</section>
		)
	}
</Page>

<style>
	.events-section {
		margin-bottom: 4rem;
	}

	.section-title {
		margin-bottom: 2rem;
		padding-bottom: 0.75rem;
		border-bottom: 3px solid var(--theme-primary);
	}

	.events-list {
		display: flex;
		flex-direction: column;
		gap: 1.5rem;
		margin: var(--s6) 0;
	}

	.past-events {
		margin-top: 3rem;
		padding-top: 3rem;
		border-top: 2px dashed #e5e7eb;
	}

	.past-events .section-title {
		border-bottom-color: #9ca3af;
		color: var(--theme-text-secondary);
	}

	.empty-state {
		text-align: center;
		padding: 4rem 2rem;
		background: #f9fafb;
		border-radius: 16px;
		margin: 2rem 0;
	}

	.empty-state p {
		color: var(--theme-text-secondary);
	}
</style>
