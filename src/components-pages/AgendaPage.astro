---
import Page from '@/layouts/Page.astro';
import { getLangFromUrl, getUrlFromID, useTranslations } from '@/i18n/utils';
import { sortedAndFilteredEvents } from '@/utils/events';
import EventListCard from '@/components/events/EventListCard.astro';
import PageHeader from '@/components/PageHeader.astro';
import type { ProcessedEvent } from '@/types/Events';

const url = Astro.url;
const lang = getLangFromUrl(url);
const t = useTranslations(lang);

const today = new Date();
const agendaSection = getUrlFromID('agenda', lang);

const events = await sortedAndFilteredEvents(lang, agendaSection, today);

// Separate events into future and past
const { processedFutureEvents, processedPastEvents } = events.reduce(
	(acc, item) => {
		if (item.isPast) {
			acc.processedPastEvents.push(item);
		} else {
			acc.processedFutureEvents.push(item);
		}
		return acc;
	},
	{ processedFutureEvents: [], processedPastEvents: [] } as {
		processedFutureEvents: ProcessedEvent[];
		processedPastEvents: ProcessedEvent[];
	}
);

const pastTitle = lang === 'eu' ? 'Iraganeko irteerak' : 'Salidas pasadas';
const emptyMessage =
	lang === 'eu'
		? 'Ez dago etorkizuneko irteerarik programatuta oraingoz.'
		: 'No hay salidas futuras programadas por el momento.';
const futureCount = processedFutureEvents.length;
---

<Page
	seo={{
		title: t('nav.agenda') + ' - Besaide Mendizale Elkartea',
		description: t('agenda.seo.description')
	}}
	pageClass="content__container"
>
	<PageHeader
		title="Agenda"
		subtitle={t('Kontsulta itzazu Besaideren irteera guztiak.')}
	/>
	{
		futureCount > 0 && (
			<p class="future-count">
				{futureCount === 1
					? t('Irteera bakarra dago planifikatuta.')
					: `${futureCount} ${t('irteera daude planifikatuta.')}`}
			</p>
		)
	}
	{
		processedFutureEvents.length > 0 ? (
			<section class="events-list">
				{processedFutureEvents.map(item => (
					<EventListCard item={item} />
				))}
			</section>
		) : (
			<div class="empty-state">
				<p>{emptyMessage}</p>
			</div>
		)
	}

	{
		processedPastEvents.length > 0 && (
			<section class="events-section past-events">
				<h2 class="section-title">{pastTitle}</h2>
				<div class="events-list">
					{processedPastEvents.slice(0, 6).map(item => (
						<EventListCard item={item} />
					))}
				</div>
			</section>
		)
	}
</Page>

<style>
	.future-count {
		color: var(--theme-primary-900);
	}
	.events-section {
		margin-bottom: 4rem;
	}

	.section-title {
		margin-bottom: 2rem;
		padding-bottom: 0.75rem;
		border-bottom: 3px solid var(--theme-primary);
	}

	.events-list {
		display: flex;
		flex-direction: column;
		gap: 1.5rem;
		margin: var(--s6) 0;
	}

	.past-events {
		margin-top: 3rem;
		padding-top: 3rem;
		border-top: 2px dashed #e5e7eb;
	}

	.past-events .section-title {
		border-bottom-color: #9ca3af;
		color: var(--theme-text-secondary);
	}

	.empty-state {
		text-align: center;
		padding: 4rem 2rem;
		background: #f9fafb;
		border-radius: 16px;
		margin: 2rem 0;
	}

	.empty-state p {
		color: var(--theme-text-secondary);
	}
</style>
