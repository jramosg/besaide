---
import Page from '@/layouts/Page.astro';
import { getLangFromUrl, getUrlFromID, useTranslations } from '@/i18n/utils';
import {
	calculateEndDateForCalendar,
	calculateStartDateWithTime,
	sortedAndFilteredEvents
} from '@/utils/events';
import EventListCard from '@/components/events/EventListCard.astro';
import type { ProcessedEvent } from '@/types/Events';
import type { CalendarEvent } from '@/types/CalendarEvent';
import { CompanyName } from '@/config/company';
import ChevronLeftIcon from '@lucide/astro/icons/chevron-left';
import ChevronRightIcon from '@lucide/astro/icons/chevron-right';
import { capitalizeFirstLetter } from '@/utils/string';
import SearchIcon from '@lucide/astro/icons/search';
import ListIcon from '@lucide/astro/icons/list';
import CalendarDaysIcon from '@lucide/astro/icons/calendar-days';
import Input from '@/components/Input.astro';
import Select, { type SelectOption } from '@/components/Select.astro';
import PageHeader from '@/components/PageHeader.astro';
import AgendaCalendar from '@/components/events/AgendaCalendar';
import '@/styles/calendar.css';

const today = new Date();

const url = Astro.url;
const { year } = Astro.params;
const yearFilter = year ? parseInt(year, 10) : today.getFullYear();
const lang = getLangFromUrl(url);
const t = useTranslations(lang);

const agendaSection = getUrlFromID('agenda', lang);

const events = await sortedAndFilteredEvents(agendaSection, today, {
	yearFilter
});

// Group events by month and separate into future/past
const { futureEventsByMonth, pastEventsByMonth } = events.reduce(
	(acc, item) => {
		const date = new Date(item.data.date);
		const year = date.getFullYear();
		const month = date.getMonth();
		const key = `${year}-${month}`;

		let title: string;
		if (lang === 'eu') {
			const monthName = new Intl.DateTimeFormat('eu', {
				month: 'long'
			}).format(date);
			const lastDigit = year % 10;
			const vowels = [0, 2, 3, 6, 8];
			const suffix = vowels.includes(lastDigit) ? 'ko' : 'eko';
			title = `${year}${suffix} ${monthName}`;
		} else {
			const monthName = new Intl.DateTimeFormat('es', {
				month: 'long'
			}).format(date);
			title = `${monthName} ${year}`;
			title = capitalizeFirstLetter(title);
		}

		if (item.isPast) {
			if (!acc.pastEventsByMonth.has(key)) {
				acc.pastEventsByMonth.set(key, {
					title,
					events: [],
					year,
					month
				});
			}
			acc.pastEventsByMonth.get(key)!.events.push(item);
		} else {
			if (!acc.futureEventsByMonth.has(key)) {
				acc.futureEventsByMonth.set(key, {
					title,
					events: [],
					year,
					month
				});
			}
			acc.futureEventsByMonth.get(key)!.events.push(item);
		}
		return acc;
	},
	{
		futureEventsByMonth: new Map<
			string,
			{
				title: string;
				events: ProcessedEvent[];
				year: number;
				month: number;
			}
		>(),
		pastEventsByMonth: new Map<
			string,
			{
				title: string;
				events: ProcessedEvent[];
				year: number;
				month: number;
			}
		>()
	}
);

const futureMonths = Array.from(futureEventsByMonth.values());
const pastMonths = Array.from(pastEventsByMonth.values());

const areFutureEvents = futureMonths.length > 0;
const arePastEvents = pastMonths.length > 0;

const pastTitle = lang === 'eu' ? 'Iraganeko irteerak' : 'Salidas pasadas';
const emptyMessage =
	lang === 'eu'
		? 'Ez dago irteerarik ' + year + ' urtean'
		: 'No hay salidas en ' + year;

const previousYear = yearFilter - 1;
const nextYear = yearFilter + 1;

// Event type filter options
const eventTypeOptions: SelectOption[] = [
	{ value: 'every', label: t('Guztiak') },
	{ value: 'mountain', label: t('event.type.mountain') },
	{ value: 'mountain-martxa', label: t('event.type.mountain-martxa') },
	{ value: 'ski-alpino', label: t('event.type.ski-alpino') },
	{ value: 'event', label: t('event.type.event') },
	{ value: 'course', label: t('event.type.course') },
	{ value: 'speleology', label: t('event.type.speleology') }
];

// Serialize events for calendar view
const calendarEvents: CalendarEvent[] = events.map(event => {
	const eventDate = new Date(event.data.date);
	const endDate = event.data.endDate ? new Date(event.data.endDate) : null;

	const startDateWithTime = calculateStartDateWithTime(
		eventDate,
		event.data.time
	);

	const endDateForCalendar = calculateEndDateForCalendar(
		endDate,
		startDateWithTime,
		event.data.durationHours
	);

	const withNotHours = !event.data.time;
	return {
		id: event.slug,
		title: event.data.title,
		start: !withNotHours
			? startDateWithTime.toISOString()
			: event.data.date.toISOString().split('T')[0],
		end: endDate
			? new Date(endDate.getTime() + 86400000).toISOString().split('T')[0]
			: endDateForCalendar?.toISOString(),
		url: event.slug,
		type: event.data.type,
		isPast: event.isPast
	};
});
---

<Page
	seo={{
		title: t('nav.agenda') + ' - ' + CompanyName,
		description: t('agenda.seo.description')
	}}
	pageClass="content__container"
>
	<div class="header-grid">
		<PageHeader title={t('Agenda')} />
		<Input
			placeholder={t('Bilatu irteerak...')}
			ariaLabel={t('agenda.search-label')}
			id="event-search"
			type="search"
			addWrapper
		>
			<SearchIcon slot="start-icon" aria-hidden="true" />
		</Input>
		<Select
			options={eventTypeOptions}
			ariaLabel={t('agenda.filter-label')}
			placeholder={t('Ekintza mota')}
			id="event-type-filter"
		/>
		<div
			id="filter-results"
			class="filter-results filter-results__mobile"
			role="status"
			aria-live="polite"
		>
		</div>
		<div
			class="view-toggle"
			role="group"
			aria-label={lang === 'eu' ? 'Ikuspegi aldaketa' : 'Cambio de vista'}
		>
			<button
				type="button"
				id="view-toggle-list"
				class="view-toggle__button"
				aria-pressed="true"
				aria-label={t('agenda.view.list')}
			>
				<ListIcon aria-hidden="true" />
				<span class="button-text">{t('agenda.view.list')}</span>
			</button>
			<button
				type="button"
				id="view-toggle-calendar"
				class="view-toggle__button"
				aria-pressed="false"
				aria-label={t('agenda.view.calendar')}
			>
				<CalendarDaysIcon aria-hidden="true" />
				<span class="button-text">{t('agenda.view.calendar')}</span>
			</button>
		</div>
	</div>

	<nav
		class="year-navigation"
		id="year-navigation"
		aria-label={lang === 'eu' ? 'Urteko nabigazioa' : 'Navegación por año'}
	>
		<a
			href={url.href.replace(`${yearFilter}`, `${previousYear}`)}
			class="year-nav-link"
			aria-label={lang === 'eu'
				? `${previousYear} urtea ikusi`
				: `Ver año ${previousYear}`}
		>
			<ChevronLeftIcon aria-hidden="true" />
			<span class="button-text">{t('Aurreko urtea')}</span>
		</a>

		<p class="current-year" aria-current="page">
			<time datetime={yearFilter.toString()} class="h3">{yearFilter}</time>
		</p>

		<a
			href={url.href.replace(`${yearFilter}`, `${nextYear}`)}
			class="year-nav-link"
			aria-label={lang === 'eu'
				? `${nextYear} urtea ikusi`
				: `Ver año ${nextYear}`}
		>
			<span class="button-text">{t('Hurrengo urtea')}</span>
			<ChevronRightIcon aria-hidden="true" />
		</a>
	</nav>

	<div id="agenda-list-view">
		{
			areFutureEvents ? (
				<section aria-labelledby="upcoming-events-heading">
					<h2 id="upcoming-events-heading" class="visually-hidden">
						{lang === 'eu' ? 'Datozen irteerak' : 'Próximas salidas'}
					</h2>
					{futureMonths.map(({ title, events }) => (
						<article class="month-section">
							<header class="month-header">
								<h3 class="month-title subtitle2">{title}</h3>
							</header>
							<ul class="events-grid" role="list">
								{events.map(item => (
									<li>
										<EventListCard item={item} />
									</li>
								))}
							</ul>
						</article>
					))}
				</section>
			) : !areFutureEvents && !arePastEvents ? (
				<div class="empty-state" role="status">
					<p>{emptyMessage}</p>
				</div>
			) : null
		}

		{
			pastMonths.length > 0 && (
				<section
					class:list={[
						'past-events-section',
						areFutureEvents ? 'past-events-section--dashed' : ''
					]}
					aria-label={pastTitle}
				>
					{pastMonths.map(({ title, events }) => (
						<article class="month-section">
							<h3 class="month-title past subtitle2">{title}</h3>
							<ul class="events-grid" role="list">
								{events.slice(0, 6).map(item => (
									<li>
										<EventListCard item={item} />
									</li>
								))}
							</ul>
						</article>
					))}
				</section>
			)
		}
	</div>

	<div id="agenda-calendar-view" style="display:none">
		<AgendaCalendar
			events={calendarEvents}
			lang={lang}
			initialYear={yearFilter}
			client:load
		/>
	</div>
</Page>

<style>
	.visually-hidden {
		position: absolute;
		width: 1px;
		height: 1px;
		padding: 0;
		margin: -1px;
		overflow: hidden;
		clip: rect(0, 0, 0, 0);
		white-space: nowrap;
		border-width: 0;
	}

	.header-grid {
		display: grid;
		grid-template-columns: auto 1fr minmax(240px, 1fr) minmax(150px, auto);
		align-items: center;
		gap: var(--s4);
		margin-bottom: var(--s6);
		row-gap: 0;
	}
	.header-grid > :global(:nth-child(1)) {
		grid-column: 1 / span 2;
	}
	.header-grid > :global(:nth-child(2)) {
		grid-column: 1;
	}
	.header-grid :global(.input-wrapper) {
		grid-column: 3;
		grid-row: 1 / span 2;
	}
	.header-grid :global(.select-container) {
		grid-column: 4;
		grid-row: 1 / span 2;
	}
	.view-toggle {
		grid-column: 1;
		grid-row: 2;
	}
	.page-title.h2 {
		margin-bottom: 0;
	}
	.page-subtitle {
		margin-bottom: 0;
	}

	.year-navigation {
		display: flex;
		justify-content: space-between;
		align-items: center;
		gap: var(--s4);
		margin-block: var(--s6);
		padding-block-end: var(--s4);
		border-block-end: 1px solid var(--theme-primary-900);
	}

	.filter-results {
		font-size: var(--font-size-sm);
		color: var(--theme-text-secondary);
		opacity: 0;
		transition: opacity 0.2s ease;
		display: none;
		top: var(--s7);
		grid-column: 3;
		margin-top: -40px;
	}

	.filter-results:not(:empty) {
		opacity: 1;
	}

	.year-nav-link {
		display: inline-flex;
		align-items: center;
		gap: var(--s2);
		padding: var(--s2) 0;
		text-decoration: none;
		color: var(--theme-on-bg);
		border-radius: var(--theme-shape-radius);
		transition:
			opacity 0.3s ease,
			color 0.3s ease,
			transform 0.3s ease;
		transform: scale(1);
		opacity: 0.8;
	}

	.year-nav-link:focus-visible {
		opacity: 1;
		color: var(--theme-primary);
		transform: scale(1.05);
		outline: 2px solid var(--theme-primary);
		outline-offset: 2px;
	}

	.year-nav-link:hover {
		opacity: 1;
		color: var(--theme-primary);
		transform: scale(1.05);
	}

	.year-nav-link:active {
		transform: scale(0.95);
	}

	.current-year {
		margin: 0;
	}

	.month-section {
		margin-block-end: var(--s8);
	}

	.month-header {
		margin-block-end: var(--s4);
	}

	.month-title {
		margin-block-end: var(--s2);
	}

	.month-title.past {
		color: var(--theme-text-secondary);
	}

	.events-grid {
		display: flex;
		flex-direction: column;
		gap: var(--s4);
		list-style: none;
		padding: 0;
		margin: 0;
	}

	.past-events-section {
		margin-block-start: var(--s8);
	}

	.past-events-section--dashed {
		border-block-start: 2px dashed var(--theme-separator);
		padding-block-start: var(--s8);
	}
	.section-title {
		margin-block-end: var(--s6);
		padding-block-end: var(--s3);
		border-block-end: 3px solid var(--theme-separator);
		color: var(--theme-text-secondary);
	}

	.empty-state {
		text-align: center;
		padding: var(--s8) var(--s4);
		background: var(--theme-primary-container-alt);
		border-radius: var(--theme-shape-radius);
		margin-block: var(--s6);
	}

	.empty-state p {
		margin: 0;
		font-size: var(--font-size-lg);
	}

	/* View Toggle Styles */
	.view-toggle {
		display: flex;
		gap: 0;
		border: 1px solid var(--theme-separator);
		border-radius: var(--theme-shape-radius);
		overflow: hidden;
		width: fit-content;
	}

	.view-toggle__button {
		display: inline-flex;
		align-items: center;
		gap: var(--s2);
		padding: var(--s2) var(--s3);
		background: transparent;
		border: none;
		color: var(--theme-on-bg);
		cursor: pointer;
		transition:
			background-color 0.2s,
			color 0.2s;
		font-size: var(--font-size-sm);
	}

	.view-toggle__button:not(:last-child) {
		border-right: 1px solid var(--theme-separator);
	}

	.view-toggle__button[aria-pressed='true'] {
		background: var(--theme-primary);
		color: var(--theme-on-primary);
	}

	.view-toggle__button:hover:not([aria-pressed='true']) {
		background: var(--theme-primary-container-alt);
	}

	.view-toggle__button:focus-visible {
		outline: 2px solid var(--theme-primary);
		outline-offset: 2px;
	}

	@media (max-width: 992px) {
		.header-grid {
			grid-template-columns: 2fr 1fr;
			gap: var(--s3);
		}

		.header-grid > :global(:nth-child(1)) {
			grid-column: 1 / span 2;
		}

		.header-grid > :global(:nth-child(2)) {
			grid-column: 1 / span 2;
		}

		.view-toggle {
			grid-column: 1 / span 2;
			grid-row: 3;
		}

		.header-grid > :global(.input-wrapper) {
			grid-column: 1;
			grid-row: 4;
		}

		.header-grid :global(.select-container) {
			grid-column: 2;
			grid-row: 4;
		}

		.filter-results {
			grid-column: 1 / span 2;
			grid-row: 5;
			margin-top: 0;
		}
	}

	@media (max-width: 600px) {
		.year-nav-link span {
			display: none;
		}

		.year-navigation {
			gap: var(--s2);
		}

		.view-toggle__button .button-text {
			display: none;
		}

		.view-toggle__button {
			padding: var(--s2);
		}

		.header-grid {
			grid-template-columns: 1fr 1fr;
			gap: var(--s3);
		}
	}
</style>

<script>
	document.addEventListener('astro:page-load', () => {
		const searchInput = document.getElementById(
			'event-search'
		) as HTMLInputElement | null;
		const typeFilter = document.getElementById(
			'event-type-filter'
		) as HTMLSelectElement | null;
		const monthSections = document.querySelectorAll('.month-section');
		const resultsDiv = document.getElementById('filter-results');

		if (!searchInput || !typeFilter) return;

		const filterEvents = () => {
			const searchTerm = searchInput.value.toLowerCase().trim();
			const selectedType = typeFilter.value;
			let totalVisible = 0;
			let totalEvents = 0;

			monthSections.forEach(section => {
				const eventCards = section.querySelectorAll(
					'.events-grid > li'
				) as NodeListOf<HTMLLIElement>;
				let visibleCount = 0;

				eventCards.forEach(card => {
					totalEvents++;
					const titleElement = card.querySelector('[data-event-title]');
					const typeElement = card.querySelector('[data-event-type]');

					const title = titleElement?.textContent?.toLowerCase() || '';
					const type = typeElement?.getAttribute('data-event-type') || '';

					const matchesSearch = !searchTerm || title.includes(searchTerm);
					const matchesType =
						!selectedType || selectedType === 'every' || type === selectedType;

					if (matchesSearch && matchesType) {
						card.style.display = '';
						visibleCount++;
						totalVisible++;
					} else {
						card.style.display = 'none';
					}
				});

				// Hide month section if no events are visible
				if (visibleCount === 0) {
					(section as HTMLElement).style.display = 'none';
				} else {
					(section as HTMLElement).style.display = '';
				}
			});

			// Update results message
			if (resultsDiv) {
				if (searchTerm || (selectedType && selectedType !== 'every')) {
					const lang = document.documentElement.lang || 'eu';
					const message =
						lang === 'eu'
							? totalVisible === 0
								? `Ez da irteerarik aurkitu`
								: totalVisible === 1
									? `Irteera bakarra aurkitu da ${totalEvents} irteeretatik`
									: `${totalVisible} irteera aurkitu dira ${totalEvents} irteeretatik`
							: totalVisible === 0
								? `No se encontraron salidas`
								: totalVisible === 1
									? `Se encontró una salida de ${totalEvents} en total`
									: `${totalVisible} salidas encontradas de ${totalEvents} en total`;
					resultsDiv.textContent = message;
					resultsDiv.style.display = 'block';
				} else {
					resultsDiv.textContent = '';
					resultsDiv.style.display = 'none';
				}
			}

			// Dispatch event for calendar view
			window.dispatchEvent(
				new CustomEvent('agenda-filter-change', {
					detail: { searchTerm, selectedType }
				})
			);
		};

		// Add event listeners
		searchInput.addEventListener('input', filterEvents);
		typeFilter.addEventListener('change', filterEvents);

		// View toggle logic
		const listViewToggle = document.getElementById('view-toggle-list');
		const calendarViewToggle = document.getElementById('view-toggle-calendar');
		const listView = document.getElementById('agenda-list-view');
		const yearNavigation = document.getElementById('year-navigation');
		const calendarView = document.getElementById('agenda-calendar-view');

		if (
			!listViewToggle ||
			!calendarViewToggle ||
			!listView ||
			!calendarView ||
			!yearNavigation
		)
			return;

		function showListView() {
			yearNavigation ? (yearNavigation.style.display = '') : null;
			listView ? (listView.style.display = '') : null;
			calendarView ? (calendarView.style.display = 'none') : null;
			listViewToggle
				? listViewToggle.setAttribute('aria-pressed', 'true')
				: null;
			calendarViewToggle
				? calendarViewToggle.setAttribute('aria-pressed', 'false')
				: null;
			sessionStorage.setItem('agenda-view', 'list');
		}

		function showCalendarView() {
			yearNavigation ? (yearNavigation.style.display = 'none') : null;
			listView ? (listView.style.display = 'none') : null;
			calendarView ? (calendarView.style.display = '') : null;
			listViewToggle
				? listViewToggle.setAttribute('aria-pressed', 'false')
				: null;
			calendarViewToggle
				? calendarViewToggle.setAttribute('aria-pressed', 'true')
				: null;
			sessionStorage.setItem('agenda-view', 'calendar');

			// Notify the calendar to update its size
			window.dispatchEvent(new CustomEvent('calendar-view-visible'));
		}

		// Restore previous view from sessionStorage
		const savedView = sessionStorage.getItem('agenda-view') || 'list';
		if (savedView === 'calendar') {
			showCalendarView();
		} else {
			showListView();
		}

		listViewToggle.addEventListener('click', showListView);
		calendarViewToggle.addEventListener('click', showCalendarView);
	});
</script>
