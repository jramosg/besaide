---
import Page from '@/layouts/Page.astro';
import {
	formatDate,
	getLangFromUrl,
	getUrlFromID,
	useTranslations
} from '@/i18n/utils';
import { slugify } from '@/utils/string';
import { getEntry, render } from 'astro:content';
import { ArrowLeft, Share2 } from '@lucide/astro';
import { processNewsItem } from '@/utils/news';
import { CompanyName } from '@/config/company';
import HeroImage from '@/components/HeroImage.astro';

const { post } = Astro.props;
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const newsSection = getUrlFromID('news', lang);
const processedPost = processNewsItem(post, lang, newsSection);

// Get the content
const contentId = post.id + '/content' + lang;
const entry = await getEntry('newsContent', contentId);
if (!entry) {
	throw new Error(`Content not found for ${contentId}`);
}
const { Content } = await render(entry);

const slug = slugify(post.id);
const summary = processedPost.summary;
---

<Page
	pageClass="content__container single-news"
	seo={{
		title: processedPost.title + ' - ' + CompanyName,
		description: summary || t('news.seo.description')
	}}
>
	<article class="single-article">
		<a href={newsSection} class="back-link">
			<ArrowLeft />
			{t('Atzera itzuli')}
		</a>
		<HeroImage
			src={processedPost.data.image}
			alt={processedPost.title}
			slug={slug}
		/>

		<div class="content__container content__container--narrow">
			<div class="header-row">
				<h1 class="title h2" style={`view-transition-name: title-${slug}`}>
					{processedPost.title}
				</h1>
				<button
					class="share-button"
					aria-label={t('Partekatu')}
					data-share-title={processedPost.title}
					data-share-text={summary}
					data-share-url={Astro.url.href}
				>
					<Share2 />
				</button>
			</div>

			<time class="overline meta" style={`view-transition-name: date-${slug}`}>
				{formatDate(post.data.date, lang)}
			</time>

			<section class="content">
				<Content />
			</section>
		</div>
	</article>
</Page>

<style>
	.back-link {
		display: inline-flex;
		align-items: center;
		gap: var(--s2);
		color: var(--theme-primary);
		text-decoration: none;
		font-weight: 600;
		margin-bottom: var(--s3);
		transition: gap 0.3s ease;
	}

	.back-link:hover {
		gap: var(--s3);
	}

	.back-link svg {
		width: 20px;
		height: 20px;
	}

	.header-row {
		display: flex;
		align-items: flex-start;
		justify-content: space-between;
		gap: var(--s3);
		margin: var(--s4) 0 var(--s2);
	}

	.title {
		margin: 0;
		flex: 1;
	}

	.share-button {
		background: none;
		border: none;
		cursor: pointer;
		padding: var(--s2);
		color: var(--theme-text-secondary);
		transition: color 0.2s ease;
		display: flex;
		align-items: center;
		justify-content: center;
		border-radius: 50%;
		flex-shrink: 0;
	}

	.share-button:hover {
		color: var(--theme-primary);
		background-color: var(--theme-primary-hover-bg);
	}

	.meta {
		display: block;
		color: var(--theme-text-secondary);
		margin-bottom: var(--s4);
	}

	.content :global(p) {
		line-height: 1.7;
		margin-bottom: var(--s3);
	}

	.content :global(a) {
		color: var(--theme-accent);
	}

	@media (max-width: 768px) {
		.title {
			font-size: 1.5rem;
		}
		.header-row {
			margin-top: var(--s3);
		}
	}
</style>

<script>
	import { shareContent } from '@/utils/share';

	document.addEventListener('astro:page-load', () => {
		const shareButton = document.querySelector('.share-button');
		if (!shareButton) return;

		shareButton.addEventListener('click', async event => {
			event.preventDefault();
			const button = event.currentTarget as HTMLButtonElement;
			const title = button.dataset.shareTitle || document.title;
			const text = button.dataset.shareText || '';
			const url = button.dataset.shareUrl || window.location.href;

			await shareContent({ title, text, url });
		});
	});
</script>
