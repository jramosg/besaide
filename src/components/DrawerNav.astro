---
import { navActions, type Nav } from '@/config/nav';
import { getLangFromUrl, getUrlFromID, useTranslations } from '@/i18n/utils';
import Button from './buttons/Button.astro';
import { ChevronDown } from '@lucide/astro';

type Props = {
	navData: Nav;
};
const { navData }: Props = Astro.props;

const url = Astro.url;
const lang = getLangFromUrl(url);
const t = useTranslations(lang);
---

<aside
	id="menu-overlay"
	class="menu-overlay"
	role="dialog"
	aria-modal="true"
	aria-label={t('Menua')}
	aria-hidden="true"
	inert
>
	<nav class="drawer-menu-nav" aria-label={t('Nabigazio nagusia')}>
		<ul class="main-list" role="list">
			{
				navData?.map((navItem, i) => {
					const hasChildren = navItem.children && navItem.children.length > 0;
					return (
						<li
							class={`drawer-menu-item subtitle ${hasChildren ? 'has-submenu' : ''}`}
							style={`transition-delay: ${(i + 1) * 100 + 200}ms`}
						>
							{hasChildren ? (
								<>
									<button
										class="drawer-menu-toggle"
										data-slug={navItem.slug}
										aria-expanded="false"
										aria-controls={`drawer-submenu-${i}`}
										tabindex="-1"
									>
										{t(navItem.title)}
										<ChevronDown
											class="chevron-icon"
											size="16"
											aria-hidden="true"
										/>
									</button>
									<ul
										class="drawer-submenu"
										id={`drawer-submenu-${i}`}
										role="list"
									>
										{navItem.children.map(child => (
											<li>
												<a
													href={getUrlFromID(child.slug, lang)}
													tabindex="-1"
													class="drawer-submenu-link"
												>
													{t(child.title)}
												</a>
											</li>
										))}
									</ul>
								</>
							) : (
								<a
									class="drawer-menu-item-link"
									href={getUrlFromID(
										navItem.slug,
										lang,
										navItem.slug === 'agenda' ? { year: 2025 } : undefined
									)}
									tabindex="-1"
								>
									{t(navItem.title)}
								</a>
							)}
						</li>
					);
				})
			}
			{
				navActions.map((action, i) => (
					<li
						style={`transition-delay: ${(i + navData.length + 1) * 100 + 200}ms`}
						class="drawer-menu-item"
					>
						<Button
							class="drawer-menu-item-button"
							bordered={i === 1}
							tonal={i === 0}
							href={getUrlFromID(action.slug, lang)}
							tabindex="-1"
						>
							{t(action.title)}
						</Button>
					</li>
				))
			}
		</ul>
	</nav>
</aside>
<div id="drawer-backdrop" class="drawer-backdrop"></div>
<style>
	:root {
		--drawer-animation: 0.3s cubic-bezier(0.4, 2, 0.6, 1);
	}
	.menu-overlay {
		padding-top: var(--header-height);
		padding-bottom: var(--s6);
		position: fixed;
		display: flex;
		flex-direction: column;
		inset: 0;
		z-index: var(--z-index-drawer);
		background: var(--theme-primary-900);
		color: var(--theme-on-primary, #fff);
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		overflow-y: auto;
		opacity: 0;
		pointer-events: none;
		transition:
			opacity var(--drawer-animation),
			transform var(--drawer-animation);
		transform: translateX(100vw);
		width: 100vw;
		max-width: 100vw;
		min-height: 100vh;
		height: 100%;
	}
	.menu-overlay.open {
		opacity: 1;
		pointer-events: auto;
		transform: translateX(0);
	}

	:global(header[drawer-open]) {
		animation: none;
	}

	:global(header[drawer-open] .header-container) {
		background-color: var(--theme-primary-900);
	}

	@media (min-width: 769px) {
		.menu-overlay {
			width: 400px;
			max-width: 90vw;
			right: 0;
			left: auto;
			inset: 0 0 0 auto;
			border-top-left-radius: var(--theme-shape-radius);
			border-bottom-left-radius: var(--theme-shape-radius);
			box-shadow: -8px 0 32px rgba(0, 0, 0, 0.12);
			transition:
				opacity var(--drawer-animation),
				transform 0.4s ease-in-out;
		}
		:global(header[drawer-open] .header-toggles__container) {
			background-color: unset;
		}
	}

	.drawer-menu-nav {
		flex: 1;
		padding-top: var(--header-height);
		ul {
			list-style: none;
			padding: 0;
			margin: 0;

			display: flex;
			flex-direction: column;
			align-items: center;

			&.main-list {
				gap: var(--s5);
			}
		}
	}

	.drawer-menu-item {
		opacity: 0;
		transform: translateY(40px) scale(0.95);
		transition:
			opacity var(--drawer-animation),
			transform var(--drawer-animation);
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
	}
	.menu-overlay.open .drawer-menu-item {
		opacity: 1;
		transform: translateY(0) scale(1);
	}

	.drawer-menu-item a:not(.drawer-menu-item-button) {
		color: var(--theme-on-primary, #fff);
		text-decoration: none;
		letter-spacing: 0.08em;
		min-height: 44px;
		transition: color 0.2s;
		display: flex;
		align-items: center;
		transition: text-shadow 0.2s;
	}

	.drawer-menu-item a:hover,
	.drawer-menu-item a:hover,
	.drawer-menu-toggle:hover {
		&:not(.drawer-menu-item-button) {
			text-shadow:
				0 2px 32px #fff,
				0 0 2px #fff;
		}
	}

	.drawer-menu-item a:focus-visible,
	.drawer-menu-toggle:focus-visible {
		outline: 2px solid var(--theme-on-primary);
		outline-offset: 4px;
		border-radius: 4px;
	}

	/* Accordion styles for mobile */
	.drawer-menu-toggle {
		background: none;
		border: none;
		color: var(--theme-on-primary, #fff);
		font-weight: 700;
		letter-spacing: 0.08em;
		font-size: inherit;
		cursor: pointer;
		padding: 0;
		display: flex;
		align-items: center;
		gap: var(--s2, 0.5rem);
		transition: color 0.2s;
		font-family: inherit;
	}

	.chevron-icon {
		transition: transform 0.3s ease;
	}

	.drawer-menu-item.has-submenu.expanded .chevron-icon {
		transform: rotate(180deg);
	}

	.drawer-submenu {
		list-style: none;
		padding: 0;
		margin: var(--s2, 0.5rem) 0 0 var(--s4, 1rem);
		max-height: 0;
		overflow: hidden;
		transition: max-height 0.3s ease;
	}

	.drawer-menu-item.has-submenu.expanded .drawer-submenu {
		max-height: 500px;
		padding-top: var(--s2, 0.5rem);
	}

	.drawer-submenu a {
		color: var(--theme-on-primary, #fff);
		text-decoration: none;
		font-weight: 400;
		font-size: 0.9em;
		transition: text-shadow 0.2s;
	}

	.drawer-submenu a:focus-visible {
		outline: 2px solid var(--theme-on-primary);
		outline-offset: 2px;
		border-radius: 4px;
	}

	.logo-menu-item {
		display: flex;
		justify-content: center;
		align-items: center;
		margin-bottom: var(--s5);
		opacity: 0;
		transform: translateY(40px) scale(0.6);
		transition:
			opacity var(--drawer-animation),
			transform var(--drawer-animation);
		position: absolute;
		top: var(--s6);
		transition-delay: 200ms;
	}
	.menu-overlay.open .logo-menu-item {
		opacity: 1;
		transform: translateY(0) scale(1);
	}

	.drawer-backdrop {
		position: fixed;
		inset: 0;
		z-index: var(--z-index-backdrop);
		background: rgba(0, 0, 0, 0.35);
		backdrop-filter: blur(2px);
		opacity: 0;
		pointer-events: none;
		transition: opacity var(--drawer-animation);
	}
	.drawer-backdrop.open {
		opacity: 1;
		pointer-events: auto;
	}
</style>

<script>
	document.addEventListener('astro:page-load', () => {
		const menuButtonContainer = document.getElementById(
			'header-burger-container'
		);
		const menuButton = document.getElementById('menuButton');
		const header = document.getElementById('besaideHeader');
		const menuOverlay = document.getElementById('menu-overlay');
		const drawerBackdrop = document.getElementById('drawer-backdrop');

		if (!menuButton || !menuOverlay || !drawerBackdrop) return;
		const { openLabel, closeLabel } = menuButton.dataset;

		let hideTimeout: null | ReturnType<typeof setTimeout>;
		let previouslyFocusedElement: HTMLElement | null = null;

		function openMenu() {
			if (!menuOverlay || !menuButton || !drawerBackdrop) return;

			// Store currently focused element
			previouslyFocusedElement = document.activeElement as HTMLElement;

			header?.setAttribute('drawer-open', '');
			menuOverlay.classList.remove('open');
			menuOverlay.style.display = 'flex';
			menuOverlay.setAttribute('aria-hidden', 'false');
			menuOverlay.removeAttribute('inert');

			// Enable all interactive elements
			const interactiveElements = menuOverlay.querySelectorAll('a, button');
			interactiveElements.forEach(el => {
				el.setAttribute('tabindex', '0');
			});

			if (hideTimeout) {
				clearTimeout(hideTimeout);
				hideTimeout = null;
			}
			// Force reflow to ensure transition triggers
			void menuOverlay.offsetWidth;
			menuOverlay.classList.add('open');
			drawerBackdrop.classList.add('open');
			menuButton.setAttribute('aria-label', closeLabel || 'Close menu');
			menuButton.setAttribute('aria-expanded', 'true');
			setTimeout(() => {
				menuButton.setAttribute('open', '');
			}, 100);
			document.body.style.overflow = 'hidden'; // Disable scroll
		}
		function closeMenu() {
			if (!menuOverlay || !menuButton || !drawerBackdrop) return;
			header?.removeAttribute('drawer-open');
			menuOverlay.classList.remove('open');
			menuOverlay.setAttribute('aria-hidden', 'true');
			menuOverlay.setAttribute('inert', '');

			// Disable all interactive elements
			const interactiveElements = menuOverlay.querySelectorAll('a, button');
			interactiveElements.forEach(el => {
				el.setAttribute('tabindex', '-1');
			});

			drawerBackdrop.classList.remove('open');
			menuButton.removeAttribute('open');
			menuButton.setAttribute('aria-expanded', 'false');
			document.body.style.overflow = ''; // Restore scroll
			menuButton.setAttribute('aria-label', openLabel || 'Open menu');

			// Restore focus to previously focused element
			if (previouslyFocusedElement) {
				previouslyFocusedElement.focus();
				previouslyFocusedElement = null;
			}

			if (hideTimeout) {
				clearTimeout(hideTimeout);
			}
			hideTimeout = setTimeout(() => {
				menuOverlay.style.display = 'none';
				hideTimeout = null;
			}, 400);
		}

		function menuToggle() {
			if (!header) return;
			if (header.hasAttribute('drawer-open')) {
				closeMenu();
			} else {
				openMenu();
			}
		}

		if (menuButtonContainer) {
			menuButtonContainer.addEventListener('click', menuToggle);
		} else {
			menuButton.addEventListener('click', menuToggle);
		}

		menuOverlay.addEventListener('click', e => {
			if (e.target === menuOverlay) closeMenu();
		});
		drawerBackdrop.addEventListener('click', closeMenu);

		// close menu on ESC key
		document.addEventListener('keydown', e => {
			if (e.key === 'Escape' && menuOverlay.classList.contains('open')) {
				closeMenu();
			}
		});

		// Accordion functionality for mobile menu
		const toggleButtons = document.querySelectorAll('.drawer-menu-toggle');
		toggleButtons.forEach(button => {
			button.addEventListener('click', event => {
				const e = event as MouseEvent;
				e.preventDefault();
				const parent = button.closest('.drawer-menu-item.has-submenu');
				const submenu = button.nextElementSibling;
				const isExpanded = button.getAttribute('aria-expanded') === 'true';

				if (parent && submenu) {
					parent.classList.toggle('expanded');
					button.setAttribute('aria-expanded', (!isExpanded).toString());

					// Enable/disable tab navigation for submenu items
					const submenuLinks = submenu.querySelectorAll('a');
					submenuLinks.forEach(link => {
						link.setAttribute('tabindex', isExpanded ? '-1' : '0');
					});
				}
			});

			// Keyboard navigation for accordion
			button.addEventListener('keydown', event => {
				const e = event as KeyboardEvent;
				const submenu = button.nextElementSibling;
				const isExpanded = button.getAttribute('aria-expanded') === 'true';

				if (e.key === 'Enter' || e.key === ' ') {
					e.preventDefault();
					(button as HTMLElement).click();
				} else if (e.key === 'ArrowDown' && isExpanded && submenu) {
					e.preventDefault();
					const firstLink = submenu.querySelector('a') as HTMLElement;
					firstLink?.focus();
				}
			});
		});

		// Trap focus within drawer when open
		const focusableElements = 'a, button, [tabindex]:not([tabindex="-1"])';

		menuOverlay?.addEventListener('keydown', event => {
			const e = event as KeyboardEvent;
			if (e.key !== 'Tab') return;

			const focusables = Array.from(
				menuOverlay.querySelectorAll(focusableElements)
			) as HTMLElement[];
			const firstFocusable = focusables[0];
			const lastFocusable = focusables[focusables.length - 1];

			if (e.shiftKey && document.activeElement === firstFocusable) {
				e.preventDefault();
				lastFocusable?.focus();
			} else if (!e.shiftKey && document.activeElement === lastFocusable) {
				e.preventDefault();
				firstFocusable?.focus();
			}
		});
	});
</script>
