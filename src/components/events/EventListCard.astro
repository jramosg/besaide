---
import { Image } from 'astro:assets';
import { slugify } from '@/utils/string';
import MountainClimb from '@/assets/icons/elevation.svg';
import DownHillSkiing from '@/assets/icons/downhill_skiing.svg';
import CardMeta from '@/components/events/CardMeta.astro';
import Chip from '@/components/Chip.astro';
import type { ImageMetadata } from 'astro';
import type { CollectionEntry } from 'astro:content';
import { getLangFromUrl, useTranslations } from '@/i18n/utils';
import { Map, Clock3 } from '@lucide/astro';
import DistanceIcon from '@/assets/icons/distance.svg';
import ElevationIcon from '@/assets/icons/elevation.svg';
import LevelIcon from '@/assets/icons/level.svg';
import { formatEventDate } from '@/utils/date';

type Difficulty = 'erraza' | 'ertaina' | 'zaila';

const difficultyLabels: Record<'eu' | 'es', Record<Difficulty, string>> = {
	eu: {
		erraza: 'Erraza',
		ertaina: 'Ertaina',
		zaila: 'Zaila'
	},
	es: {
		erraza: 'Fácil',
		ertaina: 'Media',
		zaila: 'Difícil'
	}
};

type ProcessedEvent = CollectionEntry<'events'> & {
	processedImage: ImageMetadata | string;
	slug: string;
};

type Props = {
	item: ProcessedEvent;
};

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const { item } = Astro.props;

const discriminant = item.data.typeSpecificFields.discriminant;

const { mountain, difficulty, elevation } =
	discriminant === 'mountain' ? item.data.typeSpecificFields.value : {};

const { location } =
	discriminant === 'ski-alpino' ? item.data.typeSpecificFields.value : {};

const startDate = new Date(item.data.date);
const endDate = item.data.endDate ? new Date(item.data.endDate) : null;
const formattedDate = formatEventDate(startDate, endDate, lang);

const difficultyLabel = difficulty
	? difficultyLabels[lang][difficulty as Difficulty]
	: undefined;
---

<a href={item.slug} class="event-row card card--elevated">
	<div class="event-image-col">
		{
			typeof item.processedImage === 'string' ? (
				<img
					src={item.processedImage}
					alt={item.data.title}
					class="event-thumbnail"
				/>
			) : (
				<Image
					src={item.processedImage}
					alt={item.data.title}
					class="event-thumbnail"
					style={`view-transition-name: image-${slugify(item.id)}`}
				/>
			)
		}
		<div class="event-header">
			<Chip variant="default">{formattedDate.toUpperCase()}</Chip>
			{
				discriminant === 'ski-alpino' ? (
					<DownHillSkiing />
				) : (
					<MountainClimb fill="currentColor" />
				)
			}
		</div>
	</div>

	<div class="event-info-col">
		<h3 class="h4">{item.data.title}</h3>
		{item.data.summary && <p class="event-summary">{item.data.summary}</p>}
		<div class="event-meta-row">
			{
				discriminant === 'mountain' ? (
					<CardMeta title={t('MENDIA')} desc={mountain || ''}>
						<Map slot="icon" />
					</CardMeta>
				) : discriminant === 'ski-alpino' ? (
					<CardMeta title={t('KOKALEKUA')} desc={location || ''}>
						<Map slot="icon" />
					</CardMeta>
				) : (
					<CardMeta title={t('MENDIA')} desc={mountain || location || ''}>
						<Map slot="icon" />
					</CardMeta>
				)
			}
			{
				item.data.meetingPoint && (
					<CardMeta
						title={t('TOPAGUNEA')}
						desc={`${item.data.meetingPoint}${item.data.time ? ' - ' + item.data.time : ''}`}
					>
						<DistanceIcon slot="icon" fill="currentColor" />
					</CardMeta>
				)
			}
			{
				item.data.duration && (
					<CardMeta title={t('IRAUPENA')} desc={item.data.duration}>
						<Clock3 slot="icon" />
					</CardMeta>
				)
			}
			{
				elevation && (
					<CardMeta title={t('DESNIBELA')} desc={elevation}>
						<ElevationIcon slot="icon" fill="currentColor" />
					</CardMeta>
				)
			}
			{
				difficultyLabel && (
					<CardMeta title={t('MAILA')} desc={difficultyLabel}>
						<LevelIcon slot="icon" fill="currentColor" />
					</CardMeta>
				)
			}
		</div>
	</div>
</a>

<style>
	.event-row {
		display: flex;
		width: 100%;
		overflow: hidden;
		text-decoration: none;
		height: 195px;
	}

	.event-image-col {
		position: relative;
		width: 236px;
		height: 195px;
		flex-shrink: 0;
		overflow: hidden;
	}

	.event-thumbnail {
		width: 100%;
		height: 100%;
		object-fit: cover;
		transition: transform 0.3s ease;
	}

	.event-row:hover .event-thumbnail {
		transform: scale(1.05);
	}

	.event-header {
		position: absolute;
		top: 0;
		left: 0;
		right: 0;
		display: flex;
		justify-content: space-between;
		align-items: center;
		padding: 1rem;
		z-index: 2;
		color: white;
	}

	.event-header :global(svg) {
		width: 1.5rem;
		height: 1.5rem;
		color: white;
		filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3));
	}

	.event-info-col {
		flex: 1;
		display: flex;
		flex-direction: column;
		justify-content: space-between;
		padding: var(--s6);
		min-width: 0;
	}

	.event-info-col h3 {
		margin: 0 0 var(--s2) 0;
		overflow: hidden;
		text-overflow: ellipsis;
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
	}

	.event-summary {
		color: var(--theme-text-secondary);
		line-height: 1.5;
		font-size: 0.9rem;
		margin: 0;
		overflow: hidden;
		text-overflow: ellipsis;
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
	}

	.event-meta-row {
		display: flex;
		flex-wrap: wrap;
		gap: var(--s6);
		align-items: end;
	}

	.event-meta-row :global(.home-agenda-meta) {
		min-width: fit-content;
	}

	@media (max-width: 1024px) {
		.event-image-col {
			width: 200px;
		}

		.event-row {
			height: auto;
			min-height: 195px;
		}

		.event-info-col {
			padding: 1rem;
		}

		.event-summary {
			font-size: 0.85rem;
		}
	}

	@media (max-width: 768px) {
		.event-row {
			flex-direction: column;
			height: auto;
		}

		.event-image-col {
			width: 100%;
			height: 200px;
		}

		.event-info-col {
			padding: 1rem;
		}

		.event-meta-row {
			gap: 0.75rem;
		}
	}
</style>
