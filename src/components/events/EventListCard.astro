---
export const prerender = false;

import { Image } from 'astro:assets';
import { slugify } from '@/utils/string';
import Chip from '@/components/Chip.astro';
import { getLangFromUrl, useTranslations } from '@/i18n/utils';
import { formatEventDate } from '@/utils/date';
import type { ProcessedEvent } from '@/types/Events';
import EventMetas from './EventMetas.astro';
import EventTypeIcon from './EventTypeIcon.astro';

type Props = {
	item: ProcessedEvent;
};

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const { item } = Astro.props;

const startDate = new Date(item.data.date);
const endDate = item.data.endDate ? new Date(item.data.endDate) : null;
const formattedDate = formatEventDate(startDate, endDate, lang);

const slug = slugify(item.id);

const summary = lang === 'eu' ? item.data.summaryEu : item.data.summaryEs;
---

<a
	href={item.slug}
	class:list={[
		'event-row card card--elevated',
		item.isPast && 'event-card--past'
	]}
>
	<div class="event-image-col">
		<Image
			src={item.data.image}
			alt={item.data.title}
			class="event-thumbnail"
			style={`view-transition-name: image-${slug}`}
		/>
		<div class="event-header">
			<Chip variant="default" style={`view-transition-name: date-chip-${slug}`}>
				{formattedDate.toUpperCase()}
			</Chip>
			<EventTypeIcon item={item} />
		</div>
	</div>

	<div class="event-info-col">
		{
			item.isPast && (
				<Chip
					class="event-card--past__chip"
					variant="error"
					style={`view-transition-name: past-event-chip-${slug}`}
				>
					{t('event.finished')}
				</Chip>
			)
		}
		<h3 class="h4" style={`view-transition-name: title-${slug}`}>
			{item.data.title}
		</h3>
		{summary && <p class="event-summary">{summary}</p>}
		<div class="event-meta-row">
			<EventMetas item={item} />
		</div>
	</div>
</a>

<style>
	.event-row {
		--height: 195px;
		display: flex;
		width: 100%;
		overflow: hidden;
		text-decoration: none;
		height: auto;
		min-height: var(--height);
		height: auto;
	}

	.event-card--past {
		position: relative;
		img,
		h3,
		.event-meta-row,
		.event-summary {
			-webkit-filter: grayscale(1);
		}
	}

	.event-card--past__chip {
		position: absolute;
		top: var(--s4);
		right: var(--s4);
	}

	.event-image-col {
		position: relative;
		width: 236px;
		height: auto;
		flex-shrink: 0;
		overflow: hidden;
		aspect-ratio: 2 / 1;
	}

	.event-thumbnail {
		width: 100%;
		height: 100%;
		object-fit: cover;
		transition: transform 0.3s ease;
	}

	.event-row:hover .event-thumbnail {
		transform: scale(1.05);
	}

	.event-header {
		position: absolute;
		top: 0;
		left: 0;
		right: 0;
		display: flex;
		justify-content: space-between;
		align-items: center;
		padding: var(--s4);
		z-index: 2;
	}

	.event-header :global(svg) {
		width: 1.5rem;
		height: 1.5rem;
		color: white;
		filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3));
	}

	.event-info-col {
		flex: 1;
		display: flex;
		flex-direction: column;
		justify-content: space-between;
		padding: var(--s6);
		min-width: 0;
	}

	.event-card--past .event-info-col h3 {
		margin: 0 0 var(--s2) 0;
		overflow: hidden;
		text-overflow: ellipsis;
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
	}

	.event-summary {
		text-overflow: ellipsis;
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}

	.event-meta-row {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(150px, max-content));
		column-gap: var(--s4);
		row-gap: var(--s2);
		align-items: end;
	}

	.event-meta-row {
	}

	.event-meta-row :global(.home-agenda-meta) {
		min-width: fit-content;
	}

	@media (max-width: 1024px) {
		.event-image-col {
			width: 200px;
		}

		.event-row {
			--height: auto;
			min-height: 195px;
		}

		.event-info-col {
			padding: 1rem;
		}
	}

	@media (max-width: 768px) {
		.event-row {
			flex-direction: column;
			height: auto;
			--img-height: 200px;
		}

		.event-image-col {
			width: 100%;
			height: var(--img-height);
		}

		.event-card--past__chip {
			top: calc(var(--img-height) - var(--s7));
			right: unset;
			left: var(--s4);
		}

		.event-info-col {
			padding: 1rem;
		}
	}
</style>
