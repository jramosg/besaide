---
import { getLangFromUrl, getUrlFromID, useTranslations } from '@/i18n/utils';
import { sortedAndFilteredEvents } from '@/staticPathsHelper';
import { processEvent } from '@/utils/events';
import type { CollectionEntry } from 'astro:content';
import HomeSectionHeader from './HomeSectionHeader.astro';
import EventCard from '@/components/events/EventCard.astro';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
let events: CollectionEntry<'events'>[] = await sortedAndFilteredEvents(lang);

// Filter future events and limit to 4
const today = new Date();
events = events.filter(event => new Date(event.data.date) >= today).slice(0, 4);

const agendaSection = getUrlFromID('agenda', lang);

const processedEvents = await Promise.all(
	events.map(item => processEvent(item, agendaSection, today))
);
---

<section id="agenda" class="home-section_container">
	<HomeSectionHeader
		title={t('Hurrengo irteerak')}
		subtitle={t(
			'Euskal mendietara eta Pirinioetara antolatutako txangoak eta mendiko jarduerak.'
		)}
		buttonText={t('Agenda osoa ikusi')}
		buttonHref={getUrlFromID('agenda', lang)}
	/>

	<div class="events-grid">
		{processedEvents.map(item => <EventCard item={item} />)}
	</div>
</section>

<style>
	.events-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, 320px);
		gap: 2rem;
	}

	@media (max-width: 768px) {
		.events-grid {
			grid-template-columns: 1fr;
			gap: 1.5rem;
		}
	}
</style>
