---
import { getLangFromUrl, getUrlFromID, useTranslations } from '@/i18n/utils';
import { sortedAndFilteredEvents } from '@/staticPathsHelper';
import type { CollectionEntry } from 'astro:content';
import UdalaitzImg from '@/assets/udalaitz.webp';
import { slugify } from '@/utils/string';
import { getEventImages, processEventImage } from '@/utils/images';
import HomeSectionHeader from './HomeSectionHeader.astro';
import EventCard from '@/components/events/EventCard.astro';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
let events: CollectionEntry<'events'>[] = await sortedAndFilteredEvents(lang);

// Filter future events and limit to 4
const today = new Date();
events = events.filter(event => new Date(event.data.date) >= today).slice(0, 4);

const agendaSection = getUrlFromID('agenda', lang);

const images = getEventImages();

const processedEvents = await Promise.all(
	events.map(async item => {
		const processedImage = await processEventImage(
			images,
			item.id,
			item.data.image,
			UdalaitzImg
		);

		return {
			...item,
			processedImage,
			slug: `${agendaSection}/${slugify(item.id)}`
		};
	})
);
---

<section id="agenda" class="home-section">
	<HomeSectionHeader
		title={t('Agenda')}
		subtitle={t('Azken albisteak eta eguneraketak')}
		buttonText={t('Agenda osoa ikusi')}
		buttonHref="/berriak"
	/>

	<div class="events-grid">
		{processedEvents.map(item => <EventCard item={item} />)}
	</div>
</section>

<style>
	.events-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, 320px);
		gap: 2rem;
		margin-bottom: 3rem;
	}

	@media (max-width: 768px) {
		.events-grid {
			grid-template-columns: 1fr;
			gap: 1.5rem;
		}
	}
</style>
