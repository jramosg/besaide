---
import { settings } from '@/config/settings';
import ThemeProvider from '../theme-switcher/ThemeProvider.astro';

import '@/styles/index.css';
import { getLangFromUrl, useTranslations } from '@/i18n/utils';
import { ClientRouter } from 'astro:transitions';
import OpenGraph from './OpenGraph.astro';
import StructuredData from './StructuredData.astro';

export interface Props {
	title?: string;
	description?: string;
	canonicalURL?: URL | string;
	image?: string;
	keywords?: string;
	alternateLanguages?: { hreflang: string; href: string }[];
	noindex?: boolean;
	openGraphProps?: {
		title?: string;
		description?: string;
		image?: string;
	};
}

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const openGraphProps = Astro.props.openGraphProps;
const title = Astro.props.title || settings.title;
const description = Astro.props.description || t(settings.description);
const canonicalURL =
	Astro.props.canonicalURL || new URL(Astro.url.pathname, Astro.site);
const keywords = Astro.props.keywords;

// Generate alternate language URLs
// konpondu!!!
const currentPath = Astro.url.pathname.replace(`/${lang}`, '');
const alternateLanguages = Astro.props.alternateLanguages || [
	{ hreflang: 'es', href: new URL(`/es${currentPath}`, Astro.site).toString() },
	{ hreflang: 'eu', href: new URL(`/eu${currentPath}`, Astro.site).toString() },
	{
		hreflang: 'x-default',
		href: new URL(`/es${currentPath}`, Astro.site).toString()
	}
];
---

<!-- Global Metadata -->
<meta http-equiv="Content-Language" content={lang} />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="format-detection" content="telephone=no" />
<link rel="icon" type="image/svg+xml" href="/favicon.png" />
<link rel="shortcut icon" href="/favicon.png" />
<link rel="sitemap" href="/sitemap-index.xml" />
<meta charset="UTF-8" />

<!-- Primary Meta Tags -->
<title>{title}</title>
<meta name="title" content={title} />
<meta name="description" content={description} />
<link rel="canonical" href={canonicalURL} />

<!-- Alternate Languages -->
{
	alternateLanguages.map(({ hreflang, href }) => (
		<link rel="alternate" hreflang={hreflang} href={href} />
	))
}

<!-- Author and Business Info -->
<meta name="author" content="Nerea Dorronsoro & Jon Ramos" />
<meta name="publisher" content="Besaide Mendizale Elkartea" />

<!-- Enhanced Keywords for SEO -->
<meta
	name="keywords"
	content={keywords ||
		(lang === 'eu'
			? 'Besaide, Mendizale Elkartea, Arrasate, Besaide Mendizale Elkartea, eski irteera, Leixargarate, Besaide bazkidetza, Mendi federazioa, Garibai 3, mendizale taldea, mendi ibilaldiak'
			: 'Besaide, Asociación de montaña, Arrasate-Mondragón, esquí alpino, Leixargarate, Socio Besaide, Federación de montaña, Garibai, club de montaña, excursiones de montaña')}
/>

<!-- Location-based meta tags -->
<meta name="geo.region" content="ES-SS" />
<meta name="geo.placename" content="Arrasate, Gipuzkoa" />
<meta name="geo.position" content="43.0651336;-2.4921267" />
<meta name="ICBM" content="43.0651336, -2.4921267" />

<!-- Robots and indexing directives -->
{
	Astro.props.noindex ? (
		<meta name="robots" content="noindex, nofollow" />
	) : (
		<meta
			name="robots"
			content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1"
		/>
	)
}

<!-- Security headers -->
<meta name="referrer" content="strict-origin-when-cross-origin" />

{
	openGraphProps ? (
		<OpenGraph
			title={openGraphProps.title || title}
			desc={openGraphProps.description || description}
			image={openGraphProps.image}
		/>
	) : (
		<OpenGraph />
	)
}
<StructuredData />

<ThemeProvider />

<ClientRouter />

<!-- Google Analytics -->
<script>
	document.addEventListener('astro:page-load', () => {
		var host = window.location.hostname;
		if (host != 'localhost') {
			// Place Google Analytics code here.
		}
	});
</script>

<!-- Google Search Console verification -->
<!-- <meta name="google-site-verification" content="your-verification-code" /> -->

<!-- Performance optimization -->
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="dns-prefetch" href="https://fonts.gstatic.com" />

<!-- Additional performance hints -->
<meta name="theme-color" content="#b11cab" />
<meta name="color-scheme" content="light dark" />

<!-- Social media optimization -->
<meta name="twitter:dnt" content="on" />

<!-- Additional meta for mobile optimization -->
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<meta name="apple-mobile-web-app-title" content="Besaide Mendizale Elkartea" />
