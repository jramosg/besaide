---
import Input from '@/components/Input.astro';
import Textarea from '@/components/Textarea.astro';
import FormField from '@/components/FormField.astro';
import Button from '@/components/buttons/Button.astro';
import '@/styles/form-shared.css';
import FormPrivacy from './FormPrivacy.astro';
import { getLangFromUrl, useTranslations } from '@/i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
---

<div
	class="contact-form-success"
	id="contact-form-success"
	style="display: none;"
>
	<h3>{t('contact.form.success.title')}</h3>
	<p>
		{t('contact.form.success.message')}
	</p>
</div>

<section id="contact-form-section">
	<form
		class="contact-form-fields"
		id="contact-form"
		novalidate
		aria-label={t('contact.form.title')}
	>
		<input type="hidden" name="language" value={lang} />

		<FormField
			label={t('contact.form.name')}
			htmlFor="name"
			required
			name="name"
		>
			<Input
				id="name"
				name="name"
				type="text"
				required={true}
				autocomplete="name"
				aria-required="true"
			/>
		</FormField>

		<FormField
			label={t('contact.form.email')}
			htmlFor="email"
			required
			name="email"
		>
			<Input
				id="email"
				name="email"
				type="email"
				required={true}
				autocomplete="email"
				aria-required="true"
			/>
		</FormField>

		<FormField label={t('contact.form.phone')} htmlFor="phone" name="phone">
			<Input id="phone" name="phone" type="tel" autocomplete="tel" />
		</FormField>

		<FormField
			label={t('contact.form.subject')}
			htmlFor="subject"
			required
			name="subject"
		>
			<select
				id="subject"
				name="subject"
				class="select-field"
				required
				aria-required="true"
			>
				<option disabled selected value=""
					>{t('contact.form.subject.placeholder')}</option
				>
				<option value="contact.form.subject.membership"
					>{t('contact.form.subject.membership')}</option
				>
				<option value="contact.form.subject.services"
					>{t('contact.form.subject.services')}</option
				>
				<option value="contact.form.subject.activities"
					>{t('contact.form.subject.activities')}</option
				>
				<option value="contact.form.subject.rental"
					>{t('contact.form.subject.rental')}</option
				>
				<option value="contact.form.subject.shelter"
					>{t('contact.form.subject.shelter')}</option
				>
				<option value="contact.form.subject.other"
					>{t('contact.form.subject.other')}</option
				>
			</select>
		</FormField>

		<FormField
			label={t('contact.form.message')}
			htmlFor="message"
			required
			name="message"
		>
			<Textarea
				id="message"
				name="message"
				rows={5}
				required={true}
				placeholder={t('contact.form.message.placeholder')}
				aria-required="true"
			/>
		</FormField>
		<FormPrivacy />

		<Button class="submit-button" id="contact-submit-button" type="submit">
			{t('form.button.submit')}
		</Button>
	</form>
</section>

<style>
	.contact-form-fields {
		display: flex;
		flex-direction: column;
		gap: var(--s4);
		margin-top: var(--s6);
	}

	.submit-button {
		margin-top: var(--s2);
		align-self: center;
	}

	.contact-form-success {
		background-color: var(--theme-success-container);
		color: var(--theme-on-success-container);
		padding: var(--s6);
		border-radius: var(--theme-shape-radius);
		text-align: center;
		margin-top: var(--s6);
	}

	.contact-form-success h3 {
		margin: 0 0 var(--s2);
		font-size: var(--font-size-xl);
	}

	.contact-form-success p {
		margin: 0;
		font-size: var(--font-size-base);
	}
</style>

<script>
	import { setupSchemaFormValidation } from '@/utils/setupSchemaFormValidation';
	import { contactFormSchema } from '@/schemas/contactForm';
	import { actions } from 'astro:actions';
	import { submitFormWithLoadingState } from '@/utils/formSubmission';
	import { toggleContactSections } from '@/utils/toggleSections';
	import { useTranslations } from '@/i18n/utils';
	import type { Langs } from '@/i18n/ui';

	document.addEventListener('astro:page-load', () => {
		const lang = document.documentElement.lang as Langs;
		const t = useTranslations(lang);

		setupSchemaFormValidation(
			'contact-form',
			contactFormSchema,
			t,
			formData => {
				const button = document.getElementById(
					'contact-submit-button'
				) as HTMLButtonElement;

				submitFormWithLoadingState({
					button,
					action: actions.submitContact,
					data: formData,
					onSuccess: () => toggleContactSections(),
					onError: error => alert(error),
					t
				});
			}
		);
	});
</script>
