---
import Input from '@/components/Input.astro';
import Checkbox from '@/components/Checkbox.astro';
import FormField from '@/components/FormField.astro';
import Button from '@/components/buttons/Button.astro';
import { getLangFromUrl, useTranslations } from '@/i18n/utils';
import '@/styles/form-shared.css';
import Container from './Container.astro';
import FormPrivacy from './FormPrivacy.astro';
import FormSection from './FormSection.astro';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
---

<FormSection
	aria-labelledby="form-title"
	id="membership-form-section"
	class="form-section__membership"
>
	<Container narrow>
		<h2 id="form-title" class="h4">
			{t('form.title')}
		</h2>

		<p class="form-instructions">
			{t('form.instructions')}
		</p>

		<form class="membership-form" id="membership-form" novalidate>
			<!-- Hidden field for language -->
			<input type="hidden" name="language" value={lang} />

			<!-- Section 1: Personal Data -->
			<fieldset class="form-section">
				<legend class="form-subtitle subtitle">
					{'1. ' + t('form.section.personal-data')}
				</legend>

				<div class="form-grid">
					<FormField
						label={t('form.field.dni')}
						htmlFor="dni"
						required
						class="form-field--full"
						name="dni"
					>
						<Input
							id="dni"
							name="dni"
							type="text"
							required={true}
							autocomplete="off"
						/>
					</FormField>

					<FormField
						label={t('form.field.name')}
						htmlFor="name"
						required
						class="form-field--full"
						name="name"
					>
						<Input
							id="name"
							name="name"
							type="text"
							required={true}
							autocomplete="given-name"
						/>
					</FormField>

					<FormField
						label={t('form.field.surnames')}
						htmlFor="surnames"
						required
						class="form-field--full"
						name="surnames"
					>
						<Input
							id="surnames"
							name="surnames"
							type="text"
							required={true}
							autocomplete="family-name"
						/>
					</FormField>

					<FormField
						label={t('form.field.birthdate')}
						htmlFor="birthdate"
						required
						class="form-field--full"
						name="birthdate"
					>
						<Input
							id="birthdate"
							name="birthdate"
							type="date"
							required={true}
							autocomplete="bday"
						/>
					</FormField>

					<FormField
						label={t('form.field.address')}
						htmlFor="address"
						required
						class="form-field--full"
						name="address"
					>
						<Input
							id="address"
							name="address"
							type="text"
							required={true}
							autocomplete="street-address"
						/>
					</FormField>

					<FormField
						label={t('form.field.town')}
						htmlFor="town"
						required
						class="form-field--full"
						name="town"
					>
						<Input
							id="town"
							name="town"
							type="text"
							required={true}
							autocomplete="address-level2"
						/>
					</FormField>

					<FormField
						label={t('form.field.postal-code')}
						htmlFor="postalCode"
						required
						class="form-field--full"
						name="postalCode"
					>
						<Input
							id="postalCode"
							name="postalCode"
							type="text"
							required={true}
							autocomplete="postal-code"
						/>
					</FormField>

					<FormField
						label={t('form.field.province')}
						htmlFor="province"
						required
						class="form-field--full"
						name="province"
					>
						<Input
							id="province"
							name="province"
							type="text"
							required={true}
							autocomplete="address-level1"
						/>
					</FormField>

					<FormField
						label={t('form.field.phone1')}
						htmlFor="phone1"
						required
						class="form-field--half"
						name="phone1"
					>
						<Input
							id="phone1"
							name="phone1"
							type="tel"
							required={true}
							autocomplete="tel"
						/>
					</FormField>

					<FormField
						label={t('form.field.phone2')}
						htmlFor="phone2"
						class="form-field--half"
						name="phone2"
					>
						<Input id="phone2" name="phone2" type="tel" autocomplete="tel" />
					</FormField>

					<FormField
						label={t('form.field.email')}
						htmlFor="email"
						required
						class="form-field--full"
						name="email"
					>
						<Input
							id="email"
							name="email"
							type="email"
							required={true}
							autocomplete="email"
						/>
					</FormField>

					<div class="form-field form-field--full">
						<Checkbox
							id="infoSpanish"
							name="infoSpanish"
							label={t('form.field.info-spanish')}
						/>
					</div>
				</div>
			</fieldset>

			<!-- Section 2: Membership -->
			<fieldset class="form-section form-section--row">
				<legend class="form-subtitle subtitle">
					{'2. ' + t('form.section.membership')}
				</legend>

				<div class="form-grid">
					<div class="form-field form-field--full">
						<Checkbox id="membership" name="membership" label={t('Bai')} />
					</div>
				</div>
			</fieldset>

			<!-- Section 3: Federation -->
			<fieldset class="form-section form-section--row">
				<legend class="form-subtitle subtitle">
					{'3. ' + t('form.field.federation') + ': '}
				</legend>

				<div class="form-grid">
					<div class="form-field form-field--full">
						<Checkbox id="federation" name="federation" label={t('Bai')} />
					</div>
				</div>
			</fieldset>

			<!-- Terms and Submit -->
			<footer class="form-footer">
				<FormPrivacy />

				<Button type="submit" class="submit-button membership-submit-button">
					{t('form.button.submit')}
				</Button>
			</footer>
		</form>
	</Container>
</FormSection>

<style>
	.form-section__membership {
		scroll-margin-top: calc(var(--header-height) + 20px);
	}
	.form-instructions {
		text-align: center;
		margin-bottom: var(--s6);
		color: var(--theme-primary-900);
		font-size: var(--font-size-sm);
		font-weight: var(--font-weight-medium);
	}

	.membership-form {
		background-color: var(--theme-card);
		padding: var(--s6);
		border-radius: var(--theme-shape-radius);
		box-shadow: var(--shadow-card);
		.membership-submit-button {
			margin-top: var(--s4);
		}
	}

	.form-section {
		margin-bottom: var(--s6);
	}

	.form-section:last-of-type {
		margin-bottom: var(--s4);
	}

	.form-section--row {
		display: flex;
		flex-direction: row;
		align-items: center;
		gap: var(--s4);
		legend {
			display: contents;
		}
	}

	.checkbox-legend {
		display: flex;
	}

	.form-subtitle {
		margin-bottom: var(--s6);
		padding: 0;
	}

	fieldset {
		border: none;
		padding: 0;
		margin: 0;
	}

	legend {
		padding: 0;
		margin-bottom: var(--s4);
	}

	.form-grid {
		display: grid;
		grid-template-columns: 1fr;
		gap: var(--s4);
	}

	@media (min-width: 768px) {
		.form-grid {
			grid-template-columns: repeat(2, 1fr);
		}

		.form-field--full {
			grid-column: 1 / -1;
		}

		.form-field--half {
			grid-column: span 1;
		}
	}

	.form-footer {
		padding-top: var(--s4);
		display: flex;
		flex-direction: column;
	}

	:global(.checkbox-wrapper) {
		padding: var(--s2) 0;
	}

	.submit-button {
		margin-top: var(--s2);
		align-self: center;
	}

	/* Responsive adjustments */
	@media (max-width: 767px) {
		.membership-form {
			padding: var(--s4);
		}
	}

	/* Error animations and styling */
	:global(.form-error) {
		margin-top: var(--s2);
		font-size: var(--font-size-sm);
		color: var(--theme-error);
		font-weight: var(--font-weight-medium);
		display: block;
		animation: slideIn 0.3s ease;
	}

	@keyframes slideIn {
		from {
			opacity: 0;
			transform: translateY(-4px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}

	:global(.input-error) {
		border-color: var(--theme-error) !important;
		box-shadow: 0 0 0 1px var(--theme-error) !important;
	}

	:global(.input-error:focus) {
		border-color: var(--theme-error) !important;
		box-shadow: 0 0 0 2px var(--theme-error-dark) !important;
	}

	/* Success and error message styles */
	.success-message,
	.error-message {
		margin-bottom: var(--s4);
		padding: var(--s4);
		border-radius: var(--theme-shape-radius);
		animation: slideIn 0.3s ease;
	}

	.success-message {
		background-color: hsl(142, 76%, 95%);
		border: 1px solid hsl(142, 76%, 70%);
		color: hsl(142, 76%, 25%);
	}

	.error-message {
		background-color: hsl(0, 76%, 95%);
		border: 1px solid hsl(0, 76%, 70%);
		color: hsl(0, 76%, 35%);
	}

	.success-message p,
	.error-message p {
		margin: 0;
		font-weight: var(--font-weight-medium);
	}
</style>

<script>
	import {
		setupFormValidation,
		type FieldValidation
	} from '@/utils/formValidation';
	import { actions } from 'astro:actions';

	import { toggleMembershipSections } from '@/utils/toggleSections';

	document.addEventListener('astro:page-load', () => {
		const lang = document.documentElement.lang;

		// Translation helper
		const translations: Record<string, Record<string, string>> = {
			eu: {
				required: 'Datu hau beharrezkoa da',
				email: 'Emaila ez da baliozkoa',
				phone: 'Gutxienez 9 zenbaki behar dira',
				postalCode: 'Posta kodea ez da baliozkoa (5 zenbaki)',
				'terms.required': 'Baldintzak onartu behar dituzu',
				loading: 'Bidaltzen...'
			},
			es: {
				required: 'Este campo es obligatorio',
				email: 'El email no es válido',
				phone: 'Se requieren al menos 9 dígitos',
				postalCode: 'El código postal no es válido (5 dígitos)',
				'terms.required': 'Debes aceptar los términos',
				loading: 'Enviando...'
			}
		};

		const t = (key: string) =>
			translations[lang][key] ||
			console.warn(`Missing translation for key: ${key}`) ||
			translations['eu'][key];

		// Define validation rules
		const validationRules: FieldValidation = {
			dni: [{ type: 'required', message: t('required') }],
			name: [{ type: 'required', message: t('required') }],
			surnames: [{ type: 'required', message: t('required') }],
			birthdate: [{ type: 'required', message: t('required') }],
			address: [{ type: 'required', message: t('required') }],
			town: [{ type: 'required', message: t('required') }],
			postalCode: [
				{ type: 'required', message: t('required') },
				{ type: 'minLength', message: t('postalCode'), value: 5 },
				{ type: 'postalCode', message: t('postalCode') }
			],
			province: [{ type: 'required', message: t('required') }],
			phone1: [
				{ type: 'required', message: t('required') },
				{ type: 'phone', message: t('phone') }
			],
			phone2: [{ type: 'phone', message: t('phone') }],
			email: [
				{ type: 'required', message: t('required') },
				{ type: 'email', message: t('email') }
			],
			terms: [{ type: 'checkbox.required', message: t('terms.required') }]
		};

		// Setup form validation
		setupFormValidation('membership-form', validationRules, async formData => {
			const button = document.querySelector(
				'.membership-submit-button'
			) as HTMLButtonElement;
			const originalText = button?.textContent || t('form.button.submit');

			try {
				if (button) {
					button.disabled = true;
					button.textContent = t('loading');
				}

				const { error } = await actions.submitMembership(formData);
				if (!error) {
					toggleMembershipSections();
				}
			} finally {
				if (button) {
					button.disabled = false;
					button.textContent = originalText;
				}
			}
		});
	});
</script>
