---
import { getLangFromUrl, useTranslations } from '@/i18n/utils';
import { ArrowRight, ArrowLeft } from '@lucide/astro';

type Props = {
	currentPage: number;
	lastPage: number;
	url: {
		current: string;
		prev?: string;
		next?: string;
		first?: string;
		last?: string;
	};
	class?: string;
};

const { currentPage, lastPage, url, class: className }: Props = Astro.props;

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Generate page numbers for display
const generatePageNumbers = (
	current: number,
	last: number,
	maxVisible: number = 2
) => {
	const pages: (number | string)[] = [];

	if (last <= maxVisible) {
		// Show all pages if total is small
		for (let i = 1; i <= last; i++) {
			pages.push(i);
		}
		return pages;
	}

	const halfVisible = Math.floor(maxVisible / 2);
	let start = Math.max(1, current - halfVisible);
	let end = Math.min(last, current + halfVisible);

	// Adjust if we're near the beginning or end
	if (current <= halfVisible) {
		end = maxVisible;
	} else if (current >= last - halfVisible) {
		start = last - maxVisible + 1;
	}

	// Add first page and ellipsis if needed
	if (start > 1) {
		pages.push(1);
		if (start > 2) {
			pages.push('...');
		}
	}

	// Add middle pages
	for (let i = start; i <= end; i++) {
		pages.push(i);
	}

	// Add ellipsis and last page if needed
	if (end < last) {
		if (end < last - 1) {
			pages.push('...');
		}
		pages.push(last);
	}

	return pages;
};

const pageNumbers = generatePageNumbers(currentPage, lastPage);

// Helper to construct URLs for different pages
const getPageUrl = (pageNum: number): string => {
	if (pageNum === 1) {
		return url.first || url.current.replace(/\/\d+$/, '');
	}

	// Extract base path from current URL and append page number
	const basePath = url.current.replace(/\/\d+$/, '');
	return `${basePath}/${pageNum}`;
};

const prevUrl = url.prev;
const nextUrl = currentPage < lastPage ? getPageUrl(currentPage + 1) : null;
---

<nav class={`pagination ${className || ''}`} aria-label={t('pagination.pages')}>
	<ul class="pagination__nav">
		<!-- Previous page -->
		<li class="pagination__item">
			{
				prevUrl ? (
					<a
						href={prevUrl}
						class="pagination__link pagination__link--prev pagination-link--text"
						aria-label={t('pagination.previous-page')}
					>
						<ArrowLeft />
						{t('Aurreko orria')}
					</a>
				) : (
					<span class="pagination__link pagination__link--prev pagination__link--disabled pagination-link--text">
						<ArrowLeft />
						{t('Aurreko orria')}
					</span>
				)
			}
		</li>

		<!-- Page numbers -->
		{
			pageNumbers.map(pageNum => (
				<li class="pagination__item">
					{pageNum === '...' ? (
						<span class="pagination__ellipsis" aria-hidden="true">
							...
						</span>
					) : pageNum === currentPage ? (
						<span
							class="pagination__link pagination__link--current"
							aria-current="page"
						>
							{pageNum}
						</span>
					) : (
						<a
							href={getPageUrl(pageNum as number)}
							class="pagination__link"
							aria-label={`${pageNum}. ${t('pagination.page')}`}
						>
							{pageNum}
						</a>
					)}
				</li>
			))
		}

		<!-- Next page -->
		<li class="pagination__item">
			{
				nextUrl ? (
					<a
						href={nextUrl}
						class="pagination__link pagination__link--next pagination-link--text"
						aria-label={t('pagination.next-page')}
					>
						{t('Hurrengo orria')}
						<ArrowRight />
					</a>
				) : (
					<span class="pagination__link pagination__link--next pagination__link--disabled pagination-link--text">
						{t('Hurrengo orria')}
						<ArrowRight />
					</span>
				)
			}
		</li>
	</ul>
</nav>

<style>
	.pagination {
		display: flex;
		justify-content: center;
		margin: 2rem 0;
	}

	.pagination__nav {
		display: flex;
		align-items: center;
		gap: var(--s2);
		list-style: none;
		margin: 0;
		padding: 0;
		flex-wrap: wrap;
	}

	.pagination__item {
		display: flex;
	}

	.pagination__link {
		display: flex;
		align-items: center;
		justify-content: center;
		min-width: 30px;
		height: 30px;
		padding: 0 var(--s2);
		background: var(--theme-primary-container-alt);
		color: var(--theme-primary-900);
		text-decoration: none;
		border-radius: 100px;
		font-weight: var(--font-weight-semibold);
		transition: all 0.2s ease;
		border: none;
	}

	.pagination__link:hover:not(.pagination__link--disabled):not(
			.pagination__link--current
		) {
		scale: 1.1;
	}

	.pagination__link:focus {
		outline: 2px solid var(--theme-primary-900);
		outline-offset: 2px;
	}

	.pagination__link--current {
		background: var(--theme-primary-900);
		color: white;
		cursor: default;
		font-weight: var(--font-weight-semibold);
	}

	.pagination__link--disabled {
		opacity: 0.5;
		cursor: not-allowed;
		pointer-events: none;
	}

	.pagination__link--prev,
	.pagination__link--next {
		display: flex;
		gap: var(--s);
		align-items: center;
		font-weight: var(--font-weight-semibold);
		svg {
			width: var(--font-size-base);
			height: var(--font-size-base);
		}
	}

	.pagination__ellipsis {
		display: flex;
		align-items: center;
		justify-content: center;
		min-width: 30px;
		height: 30px;
		color: var(--theme-primary-900);
		font-weight: 600;
		font-size: 1rem;
	}

	/* Responsive adjustments */
	@media (max-width: 640px) {
		.pagination__nav {
			gap: 0.25rem;
		}

		.pagination__link {
			min-width: 28px;
			height: 28px;
			padding: 0 0.5rem;
			font-size: 0.8rem;
		}

		.pagination__link--prev,
		.pagination__link--next {
			padding: 0 0.75rem;
			font-size: 0.8rem;
		}
	}

	.pagination-link--text {
		background-color: transparent;
	}
</style>
