---
import Burger from 'components/buttons/Burger.astro';
import { nav, navActions, type Nav } from 'config/nav';
import {
	getLangFromUrl,
	useTranslations,
	getUrlFromID,
	getIdfromUrl
} from 'i18n/utils';
import LanguageToggle from 'components/LanguageToggle.astro';
import ThemeSwitcher from 'components/theme-switcher/ThemeSwitcher.astro';
import Button from '@/components/buttons/Button.astro';
import { ChevronDown } from '@lucide/astro';

type Props = {
	navData: Nav;
	rightMenu?: boolean;
	transparent?: boolean;
};
const { navData, rightMenu }: Props = Astro.props;

const url = Astro.url;
const lang = getLangFromUrl(url);
const t = useTranslations(lang);

const currentPageId = getIdfromUrl(url);
const headerClasses = [rightMenu && 'header--right', 'header--transparent']
	.filter(Boolean)
	.join(' ');
---

<header id="besaideHeader" class={headerClasses}>
	<div class="header-toggles__container">
		<LanguageToggle />
		<ThemeSwitcher />
	</div>
	<div class="header-logo-menu__container">
		<a
			class="header-logo__link"
			aria-label={t('Orri nagusira joan')}
			href={getUrlFromID('', lang)}
		>
			<slot name="logo" />
		</a>
	</div>

	<div class="header-nav__container">
		<nav>
			<ul>
				{
					navData.map((navItem, index) => {
						const isActive =
							navItem.slug === currentPageId ||
							navItem.children.some(child => child.slug === currentPageId);
						const hasChildren = navItem.children.length > 0;
						const dropdownId = `dropdown-${index}`;

						return (
							<li
								class={`header-nav__item button-text ${hasChildren ? 'has-dropdown' : ''}`}
							>
								{hasChildren ? (
									<button
										class={`dropdown-trigger ${isActive ? 'nav-link--active' : ''}`}
										aria-haspopup="true"
										aria-expanded="false"
										aria-controls={dropdownId}
										data-dropdown-trigger
									>
										{t(navItem.title)}
										<ChevronDown class="dropdown-arrow" size={16} />
									</button>
								) : (
									<a
										class={'nav-link ' + (isActive ? 'nav-link--active' : '')}
										href={getUrlFromID(navItem.slug, lang)}
									>
										{t(navItem.title)}
									</a>
								)}
								{hasChildren && (
									<ul class="dropdown-menu" id={dropdownId} role="menu">
										{navItem.children.map(child => {
											const isChildActive = child.slug === currentPageId;
											return (
												<li role="none" class="nav-child--list-item">
													<a
														class={
															'nav-child ' +
															(isChildActive ? 'nav-child--active' : '')
														}
														href={getUrlFromID(child.slug, lang)}
														role="menuitem"
													>
														{t(child.title)}
													</a>
												</li>
											);
										})}
									</ul>
								)}
							</li>
						);
					})
				}
			</ul>
		</nav>
	</div>
	<div class="header-action-item__container">
		{
			navActions.map((action, i) => (
				<Button
					outlined={i !== navActions.length - 1}
					href={getUrlFromID(action.slug, lang)}
				>
					{t(action.title)}
				</Button>
			))
		}
		<Burger
			id="menuButton"
			aria-label={t('Menua ireki')}
			data-open-label={t('Menua ireki')}
			data-close-label={t('Menua itxi')}
			navData={nav}
		/>
	</div>
</header>

<style>
	header {
		--transition-transform: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
		--transition-height: height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
		width: 100%;
		height: var(--header-height);
		display: grid;
		grid-template-columns: auto 1fr auto;
		grid-template-rows: var(--header-toggles-height) var(
				--header-content-height
			);
		align-items: center;
		position: fixed;
		align-items: center;
		top: 0;
		z-index: 200;
		transition:
			var(--transition-height),
			var(--transition-transform),
			padding-top 0.3s cubic-bezier(0.4, 0, 0.2, 1);
		background-color: var(--theme-bg);
	}

	.header-logo-menu__container,
	.header-nav__container,
	.header-action-item__container {
		transition: var(--transition-transform);
	}
	.header-toggles__container {
		grid-column: span 3 / span 3;
		align-items: center;
		display: flex;
		justify-content: end;
		align-items: center;
		border-bottom: 1px solid var(--theme-outline);
		height: var(--header-toggles-height);
		opacity: 1;
		gap: var(--s2);
		transform: translateY(0);
		transition:
			var(--transition-height),
			opacity 0.25s ease-in,
			var(--transition-transform);
		padding: var(--container-padding);
	}

	header.header--transparent {
		background-color: color-mix(in srgb, var(--theme-bg) 60%, transparent);
		backdrop-filter: blur(10px);
	}

	header.header-nav__container--scrolling-down {
		height: var(--header-content-height);

		.header-toggles__container {
			height: 0;
			opacity: 0;
			overflow: hidden;
			transform: translateY(-100%);
		}

		.header-logo-menu__container,
		.header-nav__container,
		.header-action-item__container {
			transform: translateY(calc(-1 * var(--header-toggles-height)));
		}
	}
	header.header--right {
		display: grid;
		grid-template-columns: 1fr auto auto auto;
	}
	.header-logo__link {
		width: fit-content;
		color: inherit;
		text-decoration: none;

		padding: var(--container-padding);
		svg {
			width: var(--s10);
		}
	}

	.header-nav__container {
		display: flex;
		justify-content: center;
	}
	.header-logo-menu__container {
		display: flex;
		align-items: center;
		height: 100%;
	}

	.header-action-item__container {
		display: flex;
		gap: var(--s2);
		align-items: center;
		height: 100%;
		justify-content: flex-end;
	}
	.header-nav__container--scrolled {
		box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
		margin-top: 0;
		opacity: 1;
		background-color: transparent;
	}

	header[drawer-open] {
		background-color: transparent;
		z-index: var(--z-index-header-drawer);
		backdrop-filter: none;
		opacity: 1;
		box-shadow: unset;
		.header-logo-menu__container {
			opacity: 0;
		}

		.header-toggles__container {
			border-bottom: none;
		}

		.lang-toggle-link {
			&:first-child::after {
				background-color: var(--theme-on-primary);
			}
		}
		.lang-option {
			color: var(--theme-on-primary);
			&:hover {
				color: var(--theme-on-primary);
			}
		}

		.besaide-theme-toggle {
			color: var(--theme-on-primary);
		}
	}

	nav {
		display: flex;
	}
	nav ul {
		margin: 0;
		padding: 0;
		list-style: none;
		display: flex;
		align-items: center;
	}

	nav ul li:not(.drawer-menu-item) a {
		text-decoration: none;
		margin-right: 1rem;
		border-bottom: 1px solid transparent;
		transition:
			color linear 200ms,
			border-bottom linear 200ms,
			transform linear 200ms;
	}

	nav ul li a:hover {
		color: var(--theme-primary-800);
		border-bottom: 1px solid var(--theme-primary-800);
	}

	.language-select__container {
		z-index: 100;
		transition: opacity 0.3s ease-in-out;
	}

	.nav-link {
		min-height: 44px;
		display: flex;
		align-items: center;
	}

	nav ul li:not(.drawer-menu-item) a.nav-link--active {
		border-bottom: 3px solid var(--theme-primary-900);
		color: var(--theme-primary-900);
	}

	.header-action-item__container {
		padding: var(--container-padding);
	}

	.header-nav__item {
		height: 100%;
		display: flex;
		align-items: center;
	}

	/* Dropdown menu styles */
	.header-nav__item.has-dropdown {
		position: relative;
	}

	.dropdown-trigger {
		background: none;
		border: none;
		border-bottom: 1px solid transparent;
		color: inherit;
		font: inherit;
		cursor: pointer;
		padding: 0;
		margin-right: 1rem;
		display: inline-flex;
		align-items: center;
		gap: 0.25rem;
		transition:
			color linear 200ms,
			border-bottom linear 200ms,
			transform linear 200ms;
	}

	.dropdown-trigger:hover {
		color: var(--theme-primary-800);
		border-bottom: 1px solid var(--theme-primary-800);
		.dropdown-arrow {
			transform: rotate(180deg);
		}
	}

	.dropdown-trigger:focus-visible {
		outline: 2px solid var(--theme-primary-800);
		outline-offset: 2px;
		border-radius: 2px;
	}

	.dropdown-trigger.nav-link--active {
		border-bottom: 3px solid var(--theme-primary-900);
		color: var(--theme-primary-900);
	}

	.dropdown-arrow {
		transition: transform 0.3s ease;
	}

	.dropdown-trigger[aria-expanded='true'] .dropdown-arrow {
		transform: rotate(180deg);
	}

	.dropdown-menu {
		position: absolute;
		display: flex;
		flex-direction: column;
		top: 100%;
		left: 0;
		background: var(--theme-bg);
		border: 1px solid var(--theme-outline);
		border-radius: var(--theme-shape-radius, 4px);
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
		list-style: none;
		padding: var(--s2, 0.5rem) 0;
		margin: 0;
		min-width: 200px;
		opacity: 0;
		visibility: hidden;
		transform: translateY(-10px);
		transition:
			opacity 0.3s ease,
			transform 0.3s ease,
			visibility 0.2s;
		z-index: var(--z-index-popover);
	}

	.header-nav__item.has-dropdown:hover .dropdown-menu,
	.dropdown-trigger[aria-expanded='true'] + .dropdown-menu {
		opacity: 1;
		visibility: visible;
		transform: translateY(0);
	}

	.dropdown-menu li {
		margin: 0;
		padding: 0;
	}

	.dropdown-menu li a {
		padding: var(--s2, 0.5rem) var(--s4, 1rem);
		color: var(--theme-on-surface);
		text-decoration: none;
		border-bottom: none !important;
		white-space: nowrap;
		width: 100%;
		display: block;
		&:hover {
			color: var(--theme-primary-900);
			transform: translateX(4px);
		}
		&:focus-visible {
			outline: 2px solid var(--theme-primary-800);
			outline-offset: -2px;
			background-color: var(--theme-surface-variant, rgba(0, 0, 0, 0.05));
		}
	}

	.dropdown-menu li:first-child a {
		border-top-left-radius: var(--theme-shape-radius);
		border-top-right-radius: var(--theme-shape-radius);
	}

	.dropdown-menu li:last-child a {
		border-bottom-left-radius: var(--theme-shape-radius);
		border-bottom-right-radius: var(--theme-shape-radius);
	}

	.nav-child--list-item {
		width: 100%;
	}
	.dropdown-menu li a.nav-child--active {
		background-color: var(--theme-primary-container);
		color: var(--theme-on-bg);
		border-bottom: none !important;
		&:hover {
			color: var(--theme-on-bg);
			transform: translateX(0);
		}
	}

	#menuButton {
		display: none;
	}

	/* Mobile styles */
	@media (max-width: 1088px) {
		header {
			padding: 0 var(--s2);
		}
		.header-nav__container {
			display: none;
		}

		.header-action-item__container button,
		.header-action-item__container a {
			display: none;
			&#menuButton {
				display: flex;
			}
		}
	}

	.menu-overlay {
		position: fixed;
		inset: 0;
		z-index: 1000;
		background: var(--theme-primary-900);
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		overflow: hidden;
		opacity: 0;
		pointer-events: none;
		transition:
			opacity 0.3s cubic-bezier(0.4, 2, 0.6, 1),
			transform 0.4s cubic-bezier(0.4, 2, 0.6, 1);
		transform: translateX(100vw); /* Start off-screen right */
	}
	.menu-overlay.open {
		opacity: 1;
		pointer-events: auto;
		transform: translateX(0);
	}

	.landing-menu-nav ul {
		list-style: none;
		padding: 0;
		margin: 0;
		display: flex;
		flex-direction: column;
		align-items: center;
		gap: var(--s5);
	}

	.drawer-menu-item {
		opacity: 0;
		transform: translateY(40px) scale(0.95);
		transition:
			opacity 0.4s cubic-bezier(0.4, 2, 0.6, 1),
			transform 0.4s cubic-bezier(0.4, 2, 0.6, 1);
	}
	.menu-overlay.open .drawer-menu-item {
		opacity: 1;
		transform: translateY(0) scale(1);
	}

	.drawer-menu-item a:hover {
		color: var(--theme-secondary, #e8944a);
		text-shadow:
			0 2px 32px #e8944a,
			0 0 2px #fff;
	}

	.logo-menu-item {
		display: flex;
		justify-content: center;
		align-items: center;
		margin-bottom: var(--s5);
		/* Inherit menu item animation */
		opacity: 0;
		transform: translateY(40px) scale(0.95);
		transition:
			opacity 0.4s cubic-bezier(0.4, 2, 0.6, 1),
			transform 0.4s cubic-bezier(0.4, 2, 0.6, 1);
		position: absolute;
		top: var(--s6);
	}
	.menu-overlay.open .logo-menu-item {
		opacity: 1;
		transform: translateY(0) scale(1);
	}
</style>

<script>
	const SCROLL_THRESHOLD = 60;
	const HEADER_ID = 'besaideHeader';
	const MOBILE_MENU_ID = 'mobile-menu';
	const LANG_TOGGLE_BTN_ID = 'lang-toggle-btn';
	const LANG_DROPDOWN_ID = 'lang-dropdown';

	const CSS_CLASSES = {
		SCROLLED: 'header-nav__container--scrolled',
		SCROLLING_DOWN: 'header-nav__container--scrolling-down'
	} as const;

	document.addEventListener('astro:page-load', () => {
		const navHeader = document.getElementById(HEADER_ID);
		const mobileMenu = document.getElementById(MOBILE_MENU_ID);
		const langToggleBtn = document.getElementById(LANG_TOGGLE_BTN_ID);
		const dropdown = document.getElementById(LANG_DROPDOWN_ID);

		if (!navHeader) return;

		let lastScrollY = window.scrollY;
		let ticking = false;

		const closeDropdown = () => {
			if (!dropdown || !langToggleBtn) return;
			dropdown.hidden = true;
			langToggleBtn.setAttribute('aria-expanded', 'false');
		};

		const handleScroll = () => {
			const currentScrollY = window.scrollY;

			// Hide dropdown on scroll
			if (
				dropdown &&
				langToggleBtn &&
				currentScrollY > SCROLL_THRESHOLD &&
				!dropdown.hidden
			) {
				closeDropdown();
				langToggleBtn.blur();
			}

			// Prevent scroll logic if mobile menu is open
			if (mobileMenu?.hasAttribute('open')) {
				navHeader.classList.remove(CSS_CLASSES.SCROLLING_DOWN);
				return;
			}

			// Header hide/show based on scroll direction
			if (currentScrollY < SCROLL_THRESHOLD) {
				navHeader.classList.remove(CSS_CLASSES.SCROLLED);
			} else {
				navHeader.classList.add(CSS_CLASSES.SCROLLED);

				if (currentScrollY > lastScrollY) {
					navHeader.classList.add(CSS_CLASSES.SCROLLING_DOWN);
				} else {
					navHeader.classList.remove(CSS_CLASSES.SCROLLING_DOWN);
				}
			}

			lastScrollY = currentScrollY;
			ticking = false;
		};

		const onScrollHandler = () => {
			if (!ticking) {
				window.requestAnimationFrame(handleScroll);
				ticking = true;
			}
		};

		window.addEventListener('scroll', onScrollHandler);

		// Dropdown menu accessibility
		const dropdownTriggers = document.querySelectorAll(
			'[data-dropdown-trigger]'
		);

		dropdownTriggers.forEach(trigger => {
			const dropdown = document.getElementById(
				trigger.getAttribute('aria-controls') || ''
			);
			if (!dropdown) return;

			const menuItems = dropdown.querySelectorAll('[role="menuitem"]');
			let currentIndex = -1;

			// Toggle dropdown on click
			trigger.addEventListener('click', e => {
				e.preventDefault();
				const isExpanded = trigger.getAttribute('aria-expanded') === 'true';
				closeAllDropdowns();
				if (!isExpanded) {
					trigger.setAttribute('aria-expanded', 'true');
					currentIndex = -1;
				}
			});

			// Keyboard navigation
			trigger.addEventListener('keydown', event => {
				const e = event as KeyboardEvent;
				const isExpanded = trigger.getAttribute('aria-expanded') === 'true';

				if (e.key === 'Enter' || e.key === ' ') {
					e.preventDefault();
					(trigger as HTMLElement).click();
					if (!isExpanded && menuItems.length > 0) {
						setTimeout(() => (menuItems[0] as HTMLElement)?.focus(), 50);
					}
				} else if (e.key === 'ArrowDown' && isExpanded) {
					e.preventDefault();
					(menuItems[0] as HTMLElement)?.focus();
				} else if (e.key === 'Escape' && isExpanded) {
					trigger.setAttribute('aria-expanded', 'false');
					(trigger as HTMLElement).focus();
				}
			});

			// Navigate through menu items
			menuItems.forEach((item, index) => {
				item.addEventListener('keydown', event => {
					const e = event as KeyboardEvent;
					if (e.key === 'ArrowDown') {
						e.preventDefault();
						currentIndex = (index + 1) % menuItems.length;
						(menuItems[currentIndex] as HTMLElement)?.focus();
					} else if (e.key === 'ArrowUp') {
						e.preventDefault();
						currentIndex = (index - 1 + menuItems.length) % menuItems.length;
						(menuItems[currentIndex] as HTMLElement)?.focus();
					} else if (e.key === 'Escape') {
						e.preventDefault();
						trigger.setAttribute('aria-expanded', 'false');
						(trigger as HTMLElement).focus();
					} else if (e.key === 'Tab') {
						trigger.setAttribute('aria-expanded', 'false');
					}
				});
			});
		});

		// Close dropdowns when clicking outside
		function closeAllDropdowns() {
			dropdownTriggers.forEach(trigger => {
				trigger.setAttribute('aria-expanded', 'false');
			});
		}

		document.addEventListener('click', e => {
			const target = e.target as HTMLElement;
			if (!target.closest('.header-nav__item')) {
				closeAllDropdowns();
			}
		});
	});
</script>
