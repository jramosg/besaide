---
import { formatDate, getLangFromUrl, getUrlFromID } from '@/i18n/utils';
import { sortedAndFilteredNewsPosts } from '@/staticPathsHelper';
import { Image } from 'astro:assets';
import type { CollectionEntry } from 'astro:content';
import type { ImageMetadata } from 'astro';
import UdalaitzImg from '@/assets/udalaitz.webp';
import { slugify } from '@/utils/string';
import Button from './buttons/Button.astro';

const lang = getLangFromUrl(Astro.url);
let news: CollectionEntry<'news'>[] = await sortedAndFilteredNewsPosts(lang);
news = news.slice(0, 5); // Limit to 5 news items for the component

const newsSection = getUrlFromID('news', lang);

const images = import.meta.glob<{ default: ImageMetadata }>(
	'/src/assets/*.{jpeg,jpg,png,gif,webp}'
);

const processedNews = await Promise.all(
	news.map(async item => {
		let processedImage: ImageMetadata | string = UdalaitzImg; // default fallback

		if (item.data.image) {
			if (item.data.image.startsWith('@/assets/')) {
				// Handle local asset imports using import.meta.glob
				const imagePath = item.data.image.replace('@/', 'src/');
				const fullPath = `/${imagePath}`;
				try {
					if (images[fullPath]) {
						processedImage = (await images[fullPath]()).default;
					} else {
						console.error(
							`Image not found: ${fullPath}. Available images:`,
							Object.keys(images)
						);
						console.error(
							`Falling back to default image for item ID: ${item.id}`
						);
					}
				} catch (error) {
					console.warn(`Could not import image: ${item.data.image}`, error);
				}
			} else if (item.data.image.startsWith('http')) {
				// Handle external URLs
			//	processedImage = item.data.image;
			}
		}

		return {
			...item,
			processedImage,
			slug: `${newsSection}/${slugify(item.id)}`
		};
	})
);
---

<section class="content__container" id="berriak">
		<div class="section-header">
			<h2>Berriak</h2>
			<p>Azken albisteak eta eguneraketak</p>
		</div>

		<div class="featured-news">
				{
					processedNews.map(item => (
						<article class="news-card featured">
							<div
								class="news-image"
								style={`view-transition-name: image-${slugify(item.id)}`}
							>
								{typeof item.processedImage === 'string' ? (
									<img
										src={item.processedImage}
										alt={item.data.imageAlt || item.data.title}
										style="width: 100%; height: 100%; object-fit: cover;"
									/>
								) : (
									<Image
										src={item.processedImage}
										alt={item.data.imageAlt || item.data.title}
										style="width: 100%; height: 100%; object-fit: cover;"
									/>
								)}
							</div>
							<div class="news-content">
								<div class="news-meta">
									<span class="news-date">{formatDate(item.data.date)}</span>
								</div>
								<h3
									style={`view-transition-name: title-${slugify(item.id)}`}
								<p>{item.data.summary}</p>
								<div class="news-actions">
									<a href={item.slug} class="read-more">
										+ info
									</a>
									<div class="share-buttons">
										<span>Partekatu lagunekin:</span>
										
									</div>
								</div>
							</div>
						</article>
					))
				}
			</div>

		<div class="news-footer">
			<Button outlined href={getUrlFromID('news', lang)}
				>Berri guztiak ikusi</Button
			>
		</div>
</section>

<style>

	.container {
		max-width: 1200px;
		margin: 0 auto;
		padding: 0 20px;
	}

	.section-header {
		margin-bottom: 4rem;
	}

	.section-header h2 {
		font-size: 2.5rem;
		font-weight: 700;
		margin-bottom: 1rem;
	}

	.section-header p {
		font-size: 1.1rem;
		color: var(--theme-text-secondary);
		max-width: 600px;
	}


	/* Featured News */
	.featured-news {
		display: grid;
		grid-template-columns: 1fr 1fr 1fr;
		margin-bottom: 3rem;
		justify-content: center;
		gap: 2rem;
	}

	.news-card {
		background: var(--theme-bg);
		border-radius: var(--theme-shape-radius);
		overflow: hidden;
		box-shadow: var(--shadow-md);
		transition: var(--theme-transition);
		border: 1px solid var(--theme-outline);
	}

	.news-card:hover {
		transform: translateY(-4px);
		box-shadow: var(--shadow-xl);
	}

	.news-card.featured {
		border-left: 4px solid var(--theme-primary);
	}

	.news-image {
		height: 150px;
		background: var(--theme-container-gradient);
		display: flex;
		align-items: center;
		justify-content: center;
		position: relative;
	}

	.news-emoji {
		font-size: 3rem;
		filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
	}

	.news-content {
		padding: 2rem;
	}

	.news-meta {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 1rem;
	}

	.news-category {
		background: var(--theme-primary);
		color: var(--theme-on-primary);
		padding: 0.25rem 0.75rem;
		border-radius: var(--theme-button-border-radius);
		font-size: 0.8rem;
		font-weight: 600;
	}

	.news-date {
		color: var(--theme-text-secondary);
		font-size: 0.9rem;
	}

	.news-content h3 {
		font-size: 1.4rem;
		font-weight: 600;
		color: var(--theme-on-bg);
		margin-bottom: 1rem;
		line-height: 1.3;
	}

	.news-content p {
		color: var(--theme-text-secondary);
		line-height: 1.6;
		margin-bottom: 1.5rem;
	}

	.news-actions {
		display: flex;
		justify-content: space-between;
		align-items: center;
		flex-wrap: wrap;
		gap: 1rem;
	}

	.read-more {
		color: var(--theme-primary);
		text-decoration: none;
		font-weight: 600;
		font-size: 0.9rem;
		text-transform: uppercase;
		letter-spacing: 0.5px;
		transition: var(--theme-transition);
	}

	.read-more:hover {
		color: var(--theme-primary-dark);
	}

	.share-buttons {
		display: flex;
		align-items: center;
		gap: 0.5rem;
	}

	.share-buttons span {
		font-size: 0.8rem;
		color: var(--theme-text-secondary);
		margin-right: 0.5rem;
	}

	.share-btn {
		display: inline-flex;
		align-items: center;
		justify-content: center;
		width: 30px;
		height: 30px;
		border-radius: 50%;
		background: #f3f4f6;
		color: #6b7280;
		text-decoration: none;
		font-size: 0.8rem;
		font-weight: 600;
		transition: all 0.3s ease;
	}

	.share-btn:hover {
		background: #2d5a3d;
		color: white;
		transform: translateY(-2px);
	}

	/* Regular News */
	.regular-news h3 {
		font-size: 1.4rem;
		font-weight: 600;
		color: #1f2937;
		margin-bottom: 1.5rem;
		padding-bottom: 0.5rem;
		border-bottom: 2px solid #e5e7eb;
	}

	.news-item {
		display: flex;
		gap: 1rem;
		padding: 1.5rem 0;
		border-bottom: 1px solid #f3f4f6;
		transition: all 0.3s ease;
	}

	.news-item:hover {
		background: #f8fafc;
		margin: 0 -1rem;
		padding-left: 1rem;
		padding-right: 1rem;
		border-radius: 8px;
	}

	.news-item:last-child {
		border-bottom: none;
	}

	.news-item-image {
		width: 60px;
		height: 60px;
		background: #f3f4f6;
		border-radius: 8px;
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 1.5rem;
		flex-shrink: 0;
	}

	.news-item-content {
		flex: 1;
	}

	.news-item-meta {
		display: flex;
		gap: 1rem;
		margin-bottom: 0.5rem;
	}

	.news-item-meta .category {
		color: #2d5a3d;
		font-size: 0.8rem;
		font-weight: 600;
	}

	.news-item-meta .date {
		color: #9ca3af;
		font-size: 0.8rem;
	}

	.news-item-content h4 {
		font-size: 1rem;
		font-weight: 600;
		color: #1f2937;
		margin-bottom: 0.5rem;
		line-height: 1.3;
	}

	.news-item-content p {
		color: #6b7280;
		font-size: 0.9rem;
		line-height: 1.4;
		margin-bottom: 0.75rem;
	}

	.read-more-simple {
		color: #2d5a3d;
		text-decoration: none;
		font-size: 0.85rem;
		font-weight: 600;
		transition: color 0.3s ease;
	}

	.read-more-simple:hover {
		color: #1a472a;
	}

	.news-footer {
		text-align: center;
	}

	.btn {
		display: inline-block;
		padding: 0.875rem 2rem;
		border-radius: 6px;
		text-decoration: none;
		font-weight: 600;
		transition: all 0.3s ease;
		font-size: 0.95rem;
	}

	.btn-outline {
		color: var(--theme-primary);
		border: 2px solid var(--theme-primary);
		background: transparent;
	}

	.btn-outline:hover {
		background: var(--theme-primary);
		color: var(--theme-on-primary);
		transform: translateY(-2px);
		box-shadow: var(--shadow-lg);
	}

	@media (max-width: 1200px) {
		.featured-news {
			grid-template-columns: 1fr 1fr;
		}
	}
	/* Mobile Styles */
	@media (max-width: 768px) {
		.featured-news {
			grid-template-columns: 1fr;
		}

		.news-actions {
			flex-direction: column;
			align-items: flex-start;
		}

		.share-buttons {
			align-self: flex-start;
		}

		.news-item {
			flex-direction: column;
		}

		.news-item-image {
			align-self: flex-start;
		}

		.section-header h2 {
			font-size: 2rem;
		}
	}

	@media (max-width: 480px) {
		.news-content {
			padding: 1.5rem;
		}

		.section-header h2 {
			font-size: 1.75rem;
		}
	}
</style>
