---
import {
	formatDate,
	getLangFromUrl,
	getUrlFromID,
	useTranslations
} from '@/i18n/utils';
import { sortedAndFilteredNewsPosts } from '@/staticPathsHelper';
import { Image } from 'astro:assets';
import type { CollectionEntry } from 'astro:content';
import UdalaitzImg from '@/assets/udalaitz.webp';
import { slugify } from '@/utils/string';
import { getGeneralImages, processGeneralImage } from '@/utils/images';
import Button from './buttons/Button.astro';
import HomeSectionHeader from './HomeSectionHeader.astro';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

let news: CollectionEntry<'news'>[] = await sortedAndFilteredNewsPosts(lang);
news = news.slice(0, 5); // Limit to 5 news items for the component

const newsSection = getUrlFromID('news', lang);

const images = getGeneralImages();

const processedNews = await Promise.all(
	news.map(async item => {
		const processedImage = await processGeneralImage(
			images,
			item.data.image,
			UdalaitzImg
		);

		return {
			...item,
			processedImage,
			slug: `${newsSection}/${slugify(item.id)}`
		};
	})
);
---

<section class="home-section_container" id="berriak">
	<HomeSectionHeader
		title={t('Azken berriak')}
		subtitle={t('Azken albisteak eta eguneraketak')}
		buttonText={t('Berri guztiak ikusi')}
		buttonHref={newsSection}
	/>

	<div class="featured-news">
		{
			processedNews.map(item => (
				<a href={item.slug} class="card card--elevated news-card">
					<div
						class="news-card-background"
						style={`view-transition-name: image-${slugify(item.id)}`}
					>
						{typeof item.processedImage === 'string' ? (
							<img
								src={item.processedImage}
								alt={item.data.imageAlt || item.data.title}
								class="background-image"
							/>
						) : (
							<Image
								src={item.processedImage}
								alt={item.data.imageAlt || item.data.title}
								class="background-image"
							/>
						)}
						<div class="news-content">
							<div class="news-meta">
								<span class="news-date">{formatDate(item.data.date)}</span>
							</div>
							<h3 style={`view-transition-name: title-${slugify(item.id)}`}>
								{item.data.title}
							</h3>
							<p>{item.data.summary}</p>
							<div class="news-actions">
								<span class="read-more">+ info</span>
								<button class="share-btn">Partekatu lagunekin</button>
							</div>
						</div>
					</div>
				</a>
			))
		}
	</div>
	<div class="news-footer">
		<Button outlined href={getUrlFromID('news', lang)}
			>Berri guztiak ikusi</Button
		>
	</div>
</section>

<style>
	.container {
		max-width: 1200px;
		margin: 0 auto;
		padding: 0 20px;
	}

	.section-header {
		margin-bottom: 4rem;
	}

	.section-header h2 {
		font-size: 2.5rem;
		font-weight: 700;
		margin-bottom: 1rem;
	}

	.section-header p {
		font-size: 1.1rem;
		color: var(--theme-text-secondary);
		max-width: 600px;
	}

	/* Featured News */
	.featured-news {
		display: grid;
		grid-template-columns: 1fr 1fr 1fr;
		margin-bottom: 3rem;
		justify-content: center;
		gap: 2rem;
	}

	.news-card {
		text-decoration: none;
		overflow: hidden;
	}

	.news-card-background {
		position: relative;
		min-height: 300px;
		height: 100%;
		display: flex;
		flex-direction: column;
		justify-content: flex-end;
		overflow: hidden;
	}

	.background-image {
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		object-fit: cover;
		z-index: 1;
	}

	.news-content {
		position: relative;
		height: 100%;
		z-index: 3;
		padding: var(--s6) var(--s6) var(--s2) var(--s6);
		display: flex;
		flex-direction: column;
		background: linear-gradient(
			to top,
			rgba(0, 0, 0, 0.85) 0%,
			rgba(0, 0, 0, 0.6) 50%,
			rgba(0, 0, 0, 0.3) 80%,
			rgba(0, 0, 0, 0) 100%
		);
		backdrop-filter: blur(1px);
		color: white;
	}

	.news-content::before {
		content: '';
		position: absolute;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background: linear-gradient(
			135deg,
			rgba(45, 90, 61, 0.1) 0%,
			rgba(0, 0, 0, 0.05) 100%
		);
		z-index: -1;
	}

	.news-meta {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 1rem;
	}

	.news-date {
		color: rgba(255, 255, 255, 0.9);
		font-size: 0.9rem;
		font-weight: 500;
		text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
	}

	.news-content h3 {
		font-size: 1.4rem;
		font-weight: 700;
		color: white;
		margin-bottom: 1rem;
		line-height: 1.3;
		text-shadow: 0 2px 4px rgba(0, 0, 0, 0.7);
	}

	.news-content p {
		color: rgba(255, 255, 255, 0.95);
		line-height: 1.6;
		margin-bottom: 1.5rem;
		text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
	}

	.news-actions {
		display: flex;
		justify-content: space-between;
		align-items: center;
		flex-wrap: wrap;
		gap: 1rem;
		flex: 1;
		align-items: flex-end;
	}

	.read-more {
		color: rgba(255, 255, 255, 0.95);
		text-decoration: none;
		font-weight: 700;
		font-size: 0.9rem;
		text-transform: uppercase;
		letter-spacing: 0.5px;
		transition: all 0.3s ease;
		text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
		border-bottom: 2px solid rgba(255, 255, 255, 0.6);
		padding-bottom: 2px;
	}

	.read-more:hover {
		color: white;
		border-bottom-color: white;
		transform: translateY(-1px);
	}

	.share-btn {
		display: inline-flex;
		align-items: center;
		justify-content: center;
		padding: 0.5rem 1rem;
		color: rgba(255, 255, 255, 0.9);
		text-decoration: none;
		font-size: 0.85rem;
		font-weight: 600;
		transition: all 0.3s ease;
		border: 1px solid rgba(255, 255, 255, 0.3);
		cursor: pointer;
		background: rgba(255, 255, 255, 0.1);
		backdrop-filter: blur(10px);
		border-radius: 20px;
		text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
	}

	.share-btn:hover {
		background: rgba(255, 255, 255, 0.2);
		border-color: rgba(255, 255, 255, 0.5);
		transform: translateY(-2px);
		color: white;
	}

	/* Regular News */
	.regular-news h3 {
		font-size: 1.4rem;
		font-weight: 600;
		color: #1f2937;
		margin-bottom: 1.5rem;
		padding-bottom: 0.5rem;
		border-bottom: 2px solid #e5e7eb;
	}

	.read-more-simple {
		color: #2d5a3d;
		text-decoration: none;
		font-size: 0.85rem;
		font-weight: 600;
		transition: color 0.3s ease;
	}

	.read-more-simple:hover {
		color: #1a472a;
	}

	.news-footer {
		text-align: center;
	}

	.btn {
		display: inline-block;
		padding: 0.875rem 2rem;
		border-radius: 6px;
		text-decoration: none;
		font-weight: 600;
		transition: all 0.3s ease;
		font-size: 0.95rem;
	}

	.btn-outline {
		color: var(--theme-primary);
		border: 2px solid var(--theme-primary);
		background: transparent;
	}

	.btn-outline:hover {
		background: var(--theme-primary);
		color: var(--theme-on-primary);
		transform: translateY(-2px);
		box-shadow: var(--shadow-lg);
	}

	@media (max-width: 1200px) {
		.featured-news {
			grid-template-columns: 1fr 1fr;
		}
	}
	/* Mobile Styles */
	@media (max-width: 768px) {
		.featured-news {
			grid-template-columns: 1fr;
		}

		.news-content h3 {
			font-size: 1.2rem;
		}

		.section-header h2 {
			font-size: 2rem;
		}
	}

	@media (max-width: 480px) {
		.news-content {
			padding: 1.5rem;
		}

		.news-content h3 {
			font-size: 1.1rem;
		}

		.section-header h2 {
			font-size: 1.75rem;
		}

		.share-btn {
			padding: 0.4rem 0.8rem;
			font-size: 0.8rem;
		}
	}
</style>

<script>
	import { toast } from '@/utils/toast';

	document.addEventListener('astro:page-load', () => {
		const shareButtons = Array.from(document.querySelectorAll('.share-btn'));
		shareButtons.forEach(btn => {
			btn.addEventListener('click', async event => {
				event.preventDefault();
				event.stopPropagation();
				// Find the closest card anchor to get the URL and title
				const anchor = btn.closest('a');
				const url = anchor ? anchor.href : window.location.href;
				const titleEl = anchor ? anchor.querySelector('h3') : null;
				const title = titleEl ? titleEl.textContent.trim() : document.title;
				const subText = anchor
					? anchor.querySelector('p')?.textContent.trim() || ''
					: '';
				const text = title + (subText.length > 0 ? ' - ' + subText : '');

				const shareData = { title, text, url };

				const copyToClipboard = async () => {
					console.log('Copying to clipboard:', url);
					/* if (!navigator.clipboard) {
						toast.error('Ezin da kopiatu, ez dago clipboard API-rik');
						return;
					} */
					const clipboardItem = new ClipboardItem({ ['text/plain']: url });
					await navigator.clipboard.write([clipboardItem]);
					toast.success('Linka kopiatu da!');
				};

				if (!navigator.canShare) {
					await copyToClipboard();
					return;
				}
				if (!navigator.canShare(shareData)) {
					await copyToClipboard();

					return;
				}
				navigator
					.share(shareData)
					.then(() => console.log('Successful share'))
					.catch(e => console.error('Error: ' + e));
			});
		});
	});
</script>
